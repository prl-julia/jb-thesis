\section{Properties of Subtyping}\label{sec:dec-sub:proofs}
%% ======================================================================

This section defines and proves multiple properties about subtyping,
most importantly:
\begin{itemize}
    \item decidability of subtyping (\thmref{thm:subtysig-terminates});
    \item transitivity of unification-free subtyping (\thmref{thm:sub-ty-trans});
    \item soundness of constrained subtyping (\thmref{thm:subtyctr-sound}) 
        and constraints resolution (\thmref{thm:solvectr-sound}).
\end{itemize}

A detailed discussion of the decidability is given in \secref{subsec:dec-proof}.
At a high-level, the subtyping algorithm terminates because:
\begin{enumerate}
    \item for each recursive call of unification-free subtyping, 
        constrained subtyping, and signature subtyping, the arguments are
        cumulatively smaller with respect to the measure function
        (\figref{fig:ty-measure});
    \item constraints resolution terminates because consistency checks terminate
        and \UEnv argument decreases with each recursive call.
\end{enumerate}

Note: particularly interesting elements of the proofs are highlighted
in \textbf{bold}.

% \paragraph*{Overview of proofs.}
% Subtyping is checked only for valid types/signatures.
% The validity check ensures the absence of recursive constraints on type
% variables as well as consistency of variable bounds.
% For subtyping of types, we assume \tyvlddflt{\ty} and \tyvlddflt{\ty'}.
% For subtyping of type signatures, we assume
% \tyvlddflt{\tysig} and \tyvld{\concat{\AEnv}{\UEnv}}{\tysig'}.

% \textbf{Termination.} The measure of a type includes the measure of its bounds.
% In all subtyping judgments, every recursive call is made with a smaller measure.
% For constraints resolution, every recursive call is made with a smaller \UEnv.

% \textbf{Notes.}
% Exists of unions is equivalent to the union of exists (in Julia subtyping),
% so treating parts of the union on the right independently is correct
% in subtyping of signatures.

% Getting the upper bound of a universal variable might be needed at either the
% signature or the type level, that's why the rules have some duplicates.
% The key is to get rid of all top-level existentials.

% Because the same semantic type can be represented with multiple syntactic types,
% e.g. with an explicit existential vs restricted existential, it may be necessary
% to open restricted existentials as top-level variables, but it is not always
% necessary. That's why the rule for signature subtyping of invariant
% constructor in a distibutivity context doesn't require all type arguments to be
% specified as variables.

\subsection{Decidability}\label{subsec:dec-proof}
%% ======================================================================

\begin{figure}
\footnotesize
\[
\begin{array}{lcl}
    \hline
    \multicolumn{3}{c}{\tymsrdflt{\ty}} \\ 
    \hline 
    \tymsrdflt{\tyany} &=& 1\\
    \tymsrdflt{\tybot} &=& 1\\
    \tymsr{\,\EmptyEnv\,}{\vany} &=& 1\\
    \tymsr{\AEnv, \varbound{\vany}{\tylb}{\tyub}}{\vany} &=& 
        1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub}\\
    \tymsr{\AEnv, \varbound{\vany'}{\tylb}{\tyub}}{\vany} &=& 
        \tymsrdflt{\vany} \\
    \tymsrdflt{\typair{\ty_1}{\ty_2}} &=& 
        1 + \tymsrdflt{\ty_1} + \tymsrdflt{\ty_2}\\
    \tymsrdflt{\tyinv\iname{\rexvar_1,\ldots,\rexvar_n}} &=&
        1 + \tymsrdflt{\rexvar_1} + \ldots + \tymsrdflt{\rexvar_n}\\
    \tymsrdflt{\tyunion{\ty_1}{\ty_2}} &=& 
        1 + \tymsrdflt{\ty_1} + \tymsrdflt{\ty_2}\\
    \\
    \hline
    \multicolumn{3}{c}{\tymsrdflt{\rexvar}} \\ 
    \hline 
    \tymsrdflt{\rexvarbound{\ty}{\ty}} &=& \tymsrdflt{\ty}\\
    \tymsrdflt{\rexvarbound{\tylb}{\tyub}} &=& 
        2\times(1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub})\\
    \\
    \hline
    \multicolumn{3}{c}{\tymsrdflt{\dctx}} \\ 
    \hline 
    \tymsrdflt{\square} &=& 0\\
    \tymsrdflt{\typair{\dctx}{\ty}} &=& 
        1 + \tymsrdflt{\dctx} + \tymsrdflt{\ty}\\
    \tymsrdflt{\typair{\ty}{\dctx}} &=& 
        1 + \tymsrdflt{\ty} + \tymsrdflt{\dctx}\\
    \\
    \hline
    \multicolumn{3}{c}{\tymsrdflt{\tysig}} \\ 
    \hline 
    \tymsrdflt{\tyany} &=& 1\\
    \multicolumn{3}{l}{\ldots} \\
    \tymsrdflt{\tyexist{\vany}{\tylb}{\tyub}{\tysig}} &=& 
        1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub} + 
        \tymsr{\AEnv,\varbound{\vany}{\tylb}{\tyub}}{\tysig}\\
    \\
    \hline
    \multicolumn{3}{c}{\tymsrdflt{\dctxsig}} \\ 
    \hline 
    \tymsrdflt{\square} &=& 0\\
    \tymsrdflt{\typair{\dctxsig}{\tysig}} &=& 
        1 + \tymsrdflt{\dctxsig} + \tymsrdflt{\tysig}\\
    \tymsrdflt{\typair{\tysig}{\dctxsig}} &=& 
        1 + \tymsrdflt{\tysig} + \tymsrdflt{\dctxsig}\\
\end{array}
\]
\caption{Measure of types and type signatures}\label{fig:ty-measure}
\end{figure}

To show the decidability of the subtyping algorithm,
I will use the measure $\msrop$ of types and type signatures,
as defined in \figref{fig:ty-measure}.
The measure function is defined recursively and is
similar to syntactic size,
except for the treatment of type variables: for variables from~\AEnv,
the measure of a variable includes the measures of its bounds.
The definition of measure for restricted existential variables \rexvar
reflects the fact that \tyinv\iname{\rexvar_1,\ldots,\rexvar_n} represents both
invariant constructors and restricted existential types.
When $\rexvar_i$ represents a single type $\ty_i$,
i.e. $\rexvar_i = \rexvarbound{\ty_i}{\ty_i}$,
its measure is simply the measure of the type $\ty_i$ in
\tyinv\iname{\ldots,\ty_i,\ldots}.
Otherwise, $\rexvar_i = \rexvarbound{\tylb_i}{\tyub_i}$ represents
an existential type with a single occurrence of the bound variable,
\tyexist{\vany_i}{\tylb_i}{\tyub_i}{\tyinv\iname{\ldots,\vany_i,\ldots}},
and measures accordingly, comprising both the binding and its single occurrence.

Note that the measure function itself always terminates and evaluates to a
positive integer. This is the case because for every recursive call
\tymsr{\AEnv'}{\ty'} of \tymsrdflt{\ty}, 
the combined syntactic size of the arguments $\size{\ty'} + \size{\AEnv'}$
is strictly smaller than $\size{\ty} + \size{\AEnv}$.
The same is true for recursive calls
\tymsr{\AEnv'}{\tysig'} of \tymsrdflt{\tysig}.
The syntactic size is defined in~\figref{fig:ty-size}.

\begin{figure}
\footnotesize
\[
\begin{array}{lcl}
    \hline
    \multicolumn{3}{c}{\size{\ty}} \\ 
    \hline 
    \size{\tyany} &=& 1\\
    \size{\tybot} &=& 1\\
    \size{\vany}  &=& 1\\
    \size{\typair{\ty_1}{\ty_2}}  &=& 1 + \size{\ty_1} + \size{\ty_2}\\
    \size{\tyinv\iname{\rexvar_1,\ldots,\rexvar_n}} &=&
        1 + \size{\rexvar_1} + \ldots + \size{\rexvar_n}\\
    \size{\tyunion{\ty_1}{\ty_2}} &=& 1 + \size{\ty_1} + \size{\ty_2}\\
    \\
    \hline
    \multicolumn{3}{c}{\size{\rexvar}} \\ 
    \hline 
    \size{\rexvarbound{\tylb}{\tyub}} &=& \size{\tylb} + \size{\tyub}\\
    \\
    \hline
    \multicolumn{3}{c}{\size{\dctx}} \\ 
    \hline 
    \size{\square} &=& 0\\
    \size{\typair{\dctx}{\ty}} &=& 
        1 + \size{\dctx} + \size{\ty}\\
    \size{\typair{\ty}{\dctx}} &=& 
        1 + \size{\ty} + \size{\dctx}\\
    \\
    \hline
    \multicolumn{3}{c}{\size{\tysig}} \\ 
    \hline 
    \size{\tyany} &=& 1\\
    \multicolumn{3}{l}{\ldots} \\
    \size{\tyexist{\vany}{\tylb}{\tyub}{\tysig}} &=& 
        1 + \size{\tylb} + \size{\tyub} + \size{\tysig}\\
    \\
    \hline
    \multicolumn{3}{c}{\size{\AEnv}} \\ 
    \hline 
    \size{\EmptyEnv} &=& 0 \\
    \size{\AEnv, \varbound{\vany}{\tylb}{\tyub}} &=& 
        \size{\AEnv} + \size{\tylb} + \size{\tyub}\\
    \\
    \hline
    \multicolumn{3}{c}{\size{\dctxsig}} \\ 
    \hline 
    \size{\square} &=& 0\\
    \size{\typair{\dctxsig}{\tysig}} &=& 
        1 + \size{\dctxsig} + \size{\tysig}\\
    \size{\typair{\tysig}{\dctxsig}} &=& 
        1 + \size{\tysig} + \size{\dctxsig}\\
\end{array}
\]
\caption{Syntactic size}\label{fig:ty-size}
\end{figure}

In the remainder of this chapter, the following facts about
the distributivity contexts
will be used implicitly (proofs are straightforward by induction):
\begin{itemize}
    \item $\plug{\dctx}{\ty} = \ty';$
    \item $\plug{\dctx}{\dctx'} = \dctx'';$
    \item $\plug{\dctx}{\plug{\dctx'}{\ty}} = 
        \plug{(\plug{\dctx}{\dctx'})}{\ty};$
    \item $\subtydflt{\dctx}{\dctx'} \land \subtydflt{\ty}{\ty'}
        \implies \subtydflt{\plug{\dctx}{\ty}}{\plug{\dctx'}{\ty'}};$
    \item $\size{\plug{\dctx}{\ty}} = \size{\dctx} + \size{\ty};$
    \item $\size{\plug{\dctxsig}{\tysig}} = \size{\dctxsig} + \size{\tysig};$
    \item $\tymsrdflt{\plug{\dctx}{\ty}} = \tymsrdflt{\dctx} + \tymsrdflt{\ty};$
    \item $\tymsrdflt{\plug{\dctxsig}{\tysig}} = 
        \tymsrdflt{\dctxsig} + \tymsrdflt{\tysig};$
    \item $\substvars(\plug\dctx\ty) = 
        \plug{\substvars(\dctx)}{\substvars(\ty)}.$    
    %\item \TODO{more as needed}
\end{itemize}

This section presents the following key properties:
\begin{itemize}
    \item termination of \subtydflt{\ty}{\ty'} (\thmref{thm:subty-terminates});
    \item termination of \tymeetdflt{\ty}{\ty'} (\lemref{lem:meet-terminates});
    \item termination of \subtyctrdflt{\ty}{\ty'} (\thmref{thm:subtyctr-terminates});
    \item termination of \solvectrdflt (\thmref{thm:solvectr-terminates});
    \item termination of \subtysigdflt{\tysig}{\tysig'} (\thmref{thm:subtysig-terminates}).
\end{itemize}

\begin{theorem}{Termination of\ \ \subtydflt{\ty}{\ty'}.}%
\label{thm:subty-terminates}
    The subtyping algorithm built from the rules of subtyping of types
    \subtydflt{\ty}{\ty'} terminates.
\end{theorem}
\begin{proof}
    It follows from the fact that for each subtyping rule, 
    the measure of each premise \subtydflt{\ty_p}{\ty'_p}
    is strictly smaller than the measure 
    of the conclusion \subtydflt{\ty}{\ty'}, i.e.
    \[\tymsrdflt{\ty_p} + \tymsrdflt{\ty'_p} \quad<\quad 
    \tymsrdflt{\ty} + \tymsrdflt{\ty'}.\]

    For example, in the case \RST{VarLeft},
    \[\tymsrdflt{\plug\dctx\tyub} + \tymsrdflt{\ty'} < 
    \tymsrdflt{\plug\dctx\vany} + \tymsrdflt{\ty'}\]
    because \[\tymsrdflt{\tyub} < \tymsrdflt{\vany} = 
        1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub}.\]
\end{proof}

% \begin{lemma}{Termination of join ($\sqcup_{\AEnv}$) and meet ($\sqcap_{\AEnv}$).}%
% \label{lem:meet-terminates}
%     $\forall \AEnv, \ty, \ty'$ both
%     \tyjoindflt{\ty}{\ty'} and \tymeetdflt{\ty}{\ty'} terminate.
% \end{lemma}
% \begin{proof}
%     \tyjoindflt{\ty}{\ty'} terminates because subtyping of types terminates
%     by~\thmref{thm:subty-terminates}.

%     \tymeetdflt{\ty}{\ty'} terminates because subtyping of types terminates
%     and for each recursive call \tymeetdflt{\ty_r}{\ty'_r} of 
%     \tymeetdflt{\ty}{\ty'}, the measure $\tymsrdflt{\ty_r} + \tymsrdflt{\ty'_r}$ 
%     is strictly smaller than $\tymsrdflt{\ty} + \tymsrdflt{\ty'}$.
% \end{proof}
\begin{lemma}{Termination of intersection ($\sqcap_{\AEnv}$).}%
\label{lem:meet-terminates}
    $\forall \AEnv, \ty, \ty',$
    \tymeetdflt{\ty}{\ty'} terminates.
\end{lemma}
\begin{proof}
    \tymeetdflt{\ty}{\ty'} terminates because subtyping of types terminates,
    and for each recursive call \tymeetdflt{\ty_r}{\ty'_r} of 
    \tymeetdflt{\ty}{\ty'}, the measure $\tymsrdflt{\ty_r} + \tymsrdflt{\ty'_r}$ 
    is strictly smaller than $\tymsrdflt{\ty} + \tymsrdflt{\ty'}$.
\end{proof}

\begin{theorem}{Termination of\ \ \subtyctrdflt{\ty}{\ty'}.}%
\label{thm:subtyctr-terminates}
    The subtyping algorithm built from the rules of
    constrained subtyping of types
    \subtyctrdflt{\ty}{\ty'} terminates.
\end{theorem}
\begin{proof}
    Similarly to the previous theorem, the measure decreases, i.e.
    \[\tymsrdflt{\ty_p} + \tymsrdflt{\ty'_p} \quad<\quad 
    \tymsrdflt{\ty} + \tymsrdflt{\ty'}\]
    for each premise \subtyctrdflt{\ty_p}{\ty'_p}
    of the conclusion \subtyctrdflt{\ty}{\ty'}.
    
    The only interesting case is \RSC{UVar-UnionRight}.
    By the variable names convention~(\defref{def:var-names}), $\va \notin \AEnv$.
    Therefore, $\tymsrdflt{\va} = \tymsrdflt{\va_1} = \tymsrdflt{\va_2}$
    and the measure of the left-hand side type is the same in both premises
    and the conclusion,
    while the measure of the right-hand side type in both premises 
    is strictly smaller than in conclusion.
    Furthermore, $\msqcap_{i=1}^n \tyub_1^i$ and $\msqcap_{j=1}^m \tyub_2^j$
    terminate by~\lemref{lem:meet-terminates}.
\end{proof}

\begin{theorem}{Termination of\ \solvectrdflt.}%
\label{thm:solvectr-terminates}
    The constraints resolution algorithm \solvectrdflt terminates.
\end{theorem}
\begin{proof}
    It follows from the fact that:
    \begin{enumerate}
        \item subtyping algorithms \subtydflt{\ty}{\ty'} and 
            \subtyctrdflt{\ty}{\ty'} used to check the consistency of 
            constraints terminate;
        \item the argument \UEnv of the only recursive call to $\solvectrop$
            is strictly smaller than that of the original call.
    \end{enumerate} 
\end{proof}


\begin{figure}
\footnotesize
\[
\begin{array}{lcl}
    \hline
    \multicolumn{3}{c}{\occdflt{\ty}} \\ 
    \hline 
    \occdflt{\tyany} &=& \false\\
    \occdflt{\tybot} &=& \false\\
    \occdflt{\vany}  &=& \true\\
    \occdflt{\vany'}  &=& \false\\
    \occdflt{\typair{\ty_1}{\ty_2}}  &=& \occdflt{\ty_1} \lor \occdflt{\ty_2}\\
    \occdflt{\tyinv\iname{\rexvar_1,\ldots,\rexvar_n}} &=&
        \occdflt{\rexvar_1} \lor \ldots \lor \occdflt{\rexvar_n}\\
    \occdflt{\tyunion{\ty_1}{\ty_2}} &=& \occdflt{\ty_1} \lor \occdflt{\ty_2}\\
    \\
    \hline
    \multicolumn{3}{c}{\occdflt{\rexvar}} \\ 
    \hline 
    \occdflt{\rexvarbound{\tylb}{\tyub}} &=& \occdflt{\tylb} \lor \occdflt{\tyub}\\
    \\
    \hline
    \multicolumn{3}{c}{\occdflt{\tysig}} \\ 
    \hline 
    \occdflt{\tyany} &=& \false\\
    \multicolumn{3}{l}{\ldots} \\
    \occdflt{\tyexist{\vany}{\tylb}{\tyub}{\tysig}} &=& \true\\
    \occdflt{\tyexist{\vany'}{\tylb}{\tyub}{\tysig}} &=& 
        \occdflt{\tylb} \lor \occdflt{\tyub} \lor \occdflt{\tysig}\\
    \\
    \hline
    \multicolumn{3}{c}{\occdflt{\AEnv}} \\ 
    \hline 
    \occdflt{\EmptyEnv} &=& \false \\
    \occdflt{\AEnv, \varbound{\vany}{\tylb}{\tyub}} &=& \true\\
    \occdflt{\AEnv, \varbound{\vany'}{\tylb}{\tyub}} &=& 
        \occdflt{\AEnv} \lor \occdflt{\tylb} \lor \occdflt{\tyub}\\
\end{array}
\]
\caption{Occurrence of a variable}\label{fig:var-occ}
\end{figure}

\begin{lemma}{Context weakening in $\msrop$.}%
\label{lem:msr-weakening}
    The measure of a type signature does not change if the environment
    is extended (in any position) with a variable that occurs neither
    in the signature nor in the environment, i.e.,
    $\forall \tysig, \AEnv, \AEnv'. 
    \forall \varbound{\vany}{\tylb}{\tyub} \text{ s.t. } 
    \lnot \occdflt{\tysig} \land 
    \lnot \occdflt{\AEnv} \land \lnot \occdflt{\AEnv'}.$
    \[\tymsr{\concat{\AEnv}{\AEnv'}}{\tysig} = 
        \tymsr{\concat{\AEnv,\varbound{\vany}{\tylb}{\tyub}}{\AEnv'}}{\tysig},\]
    where \concat{\AEnv}{\AEnv''} denotes the concatenation of lists,
    and $\occop$ is defined in~\figref{fig:var-occ}.
\end{lemma}
\begin{proof}
    By strong induction on $n = \size{\AEnv} + \size{\AEnv'} + \size{\tysig}$.
    \lemproofrefapp{lem:msr-weakening:app}
\end{proof}

\begin{theorem}{Termination of\ \ \subtysigdflt{\tysig}{\tysig'}.}%
\label{thm:subtysig-terminates}
    The subtyping algorithm built from the rules of
    subtyping of type signatures
    \subtysigdflt{\tysig}{\tysig'} terminates.
\end{theorem}
\begin{proof}
    It follows from the fact that for each subtyping rule, 
    the measure of each premise \subtysigdflt{\tysig_p}{\tysig'_p}
    is strictly smaller than the measure 
    of the conclusion \subtysigdflt{\tysig}{\tysig'}, i.e.
    \[\tymsr{\AEnv'}{\tysig_p} + \tymsr{\concat{\AEnv'}{\UEnv'}}{\tysig'_p} \quad<\quad 
    \tymsr{\AEnv}{\tysig} + \tymsr{\concat{\AEnv}{\UEnv}}{\tysig'}.\]

    Most of the cases are similar to the cases of~\thmref{thm:subty-terminates}
    on the termination of \subtydflt{\ty}{\ty'}.
    The remaining cases are:
    \begin{itemize}
        \item \RSS{InvLeft}. Since \vx is a fresh variable,
            by~\lemref{lem:msr-weakening} (weakening),
            $\tymsr{\AEnv, \varbound{\vx}{\tylb}{\tyub}}
                {\plug\dctxsig{\tyinv\iname{\ldots}}} = 
            \tymsrdflt{\plug\dctxsig{\tyinv\iname{\ldots}}},$ and also
            $\tymsr{\concat{\AEnv, \varbound{\vx}{\tylb}{\tyub}}{\UEnv}}{\tysig'}
            = \tymsr{\concat{\AEnv}{\UEnv}}{\tysig'}.$

            By the definition of $\msrop$,
            \[
                \begin{array}{cl}
                    & \tymsr{\AEnv, \varbound{\vx}{\tylb}{\tyub}}{\vx} \\
                  = & 1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub} \\
                  < & 2\times(1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub}) \\
                  = & \tymsrdflt{\rexvarbound{\tylb}{\tyub}},
                \end{array}
            \]
            which concludes the case.
        \item \RSS{ExistLeft}. By the variables names
            convention~(\defref{def:var-names}), \vx is different from variables
            in \AEnv, \UEnv, as well as bound variables of \dctxsig, \tysig,
            and $\tysig'$. Therefore, by~\lemref{lem:msr-weakening} (weakening),
            $\tymsr{\AEnv, \varbound{\vx}{\tylb}{\tyub}}{\dctxsig} = 
            \tymsrdflt{\dctxsig}$, and similarly for $\tysig'$.
            By the definition of $\msrop$,
            \[\tymsrdflt{\tyexist{\vx}{\tylb}{\tyub}{\tysig}} = 1 +
                \tymsrdflt{\tylb} + \tymsrdflt{\tyub} + 
                \tymsr{\AEnv, \varbound{\vx}{\tylb}{\tyub}}{\tysig},\]
            which is strictly larger than
            \tymsr{\AEnv, \varbound{\vx}{\tylb}{\tyub}}{\tysig} in the premise,
            which concludes the case.
        \item \RSS{ExistRight}. Similarly to \RSS{ExistLeft}.
        \item \RSS{Types}. The first premise,
            \subtyctrR{\AEnv}{\dom\UEnv}{\ty}{\ty'}{\CSet},
            terminates by \thmref{thm:subtyctr-terminates}.
            Since the constraints resolution \solvectrdflt terminates
            by \thmref{thm:solvectr-terminates}, the entire step also terminates.
    \end{itemize}
\end{proof}


\subsection{Unification-Free Subtyping}%
\label{subsec:props-subty-proof}
%% ======================================================================

This section presents the following key properties:
\begin{itemize}
    \item reflexivity \subtydflt{\ty}{\ty} (\thmref{thm:sub-ty-refl});
    \item transitivity $\subtydflt{\ty_1}{\ty_2} \ \ \land\ \ 
        \subtydflt{\ty_2}{\ty_3} \implies \subtydflt{\ty_1}{\ty_3}$
        (\thmref{thm:sub-ty-trans});
    \item soundness with respect to substitution (\thmref{thm:subty-sound-subst}).
\end{itemize}

\begin{theorem}{Reflexivity of subtyping of types.}\label{thm:sub-ty-refl}
    $\forall \ty, \AEnv, \text{ s.t. } \tyvlddflt{\ty}.$
    \[\subtydflt{\ty}{\ty}.\]
\end{theorem}
\begin{proof}
    By induction on the structure of \ty.
    \begin{itemize}
        \item Case \tyany by \RST{Top}.
        \item Case \tybot by \RST{Bot}.
        \item Case \vany by \RST{VarRefl}.
        \item Case \typair{\ty_1}{\ty_2} by IH and \RST{Tuple}.
        \item Case \tyinv\iname{\rexvar_1,\ldots,\rexvar_n} by IH on
            $\tylb_i, \tyub_i$, and \RST{Inv}.
        \item Case \tyunion{\ty_1}{\ty_2} by IH, \RST{UnionRight},
            and \RST{UnionLeft}.
    \end{itemize}
\end{proof}

\begin{lemma}{Subtyping of \tybot implies arbitrary subtyping.}\label{lem:sub-of-bot}
    \[
    \forall \ty, \dctx_{\tybot}, \AEnv.\quad 
    \subtydflt{\ty}{\plug{\dctx_{\tybot}}\tybot}
    \quad\implies\quad
    (\forall \ty', \dctx'.\quad \subtydflt{\plug{\dctx'}{\ty}}{\ty'}).
    \]
\end{lemma}
\begin{proof}
    By induction on the derivation of 
    \subtydflt{\ty}{\plug{\dctx_{\tybot}}\tybot}.
    \lemproofrefapp{lem:sub-of-bot:app}
\end{proof}

\begin{lemma}{Subtyping of inner union on the right.}%
\label{lem:sub-inner-union-right}
    $\forall \ty, \dctx', \ty'_1, \ty'_2, \AEnv, \text{ s.t. }$\\
    $\tyvld{}{\AEnv}\ \land\ \tyvlddflt{\ty, \dctx', \ty'_1, \ty'_2}.$
    \[
        \begin{array}{ccc}
        \subtydflt{\ty}{\plug{\dctx'}{\tyunion{\ty'_1}{\ty'_2}}}\\
        \quad\implies\quad\\
        (\forall \dctx_1, \dctx_2, \text{ s.t. }
        \tyvlddflt{\dctx_1, \dctx_2} \land
        \subtydflt{\dctx_1}{\dctx_2}.\quad
        \subtydflt
            {\plug{\dctx_1}{\ty}}
            {\tyunion
                {\plug{\dctx_2}{\plug{\dctx'}{\ty'_1}}}
                {\plug{\dctx_2}{\plug{\dctx'}{\ty'_2}}}
            }).
        \end{array}
    \]
\end{lemma}
\begin{proof}
    By induction on the derivation of
    \subtydflt{\ty}{\plug{\dctx'}{\tyunion{\ty'_1}{\ty'_2}}}.
    \lemproofrefapp{lem:sub-inner-union-right:app}
\end{proof}

\begin{lemma}{Adding inner union on the right.}%
\label{lem:add-inner-union-right}
    $\forall \ty, \dctx', \ty', \AEnv, \text{ s.t. }
    \tyvld{}{\AEnv}\ \land\ \tyvlddflt{\ty, \dctx', \ty'}.$
    \[
        \subtydflt{\ty}{\plug{\dctx'}{\ty'}}
        \quad\implies\quad
        (\forall \ty''.\ \subtydflt{\ty}{\plug{\dctx'}{\tyunion{\ty'}{\ty''}}}).
    \]
\end{lemma}
\begin{proof}
    By induction on the derivation of
    \subtydflt{\ty}{\plug{\dctx'}{\ty'}}.
    \lemproofrefapp{lem:add-inner-union-right:app}
\end{proof}

\begin{lemma}{Subtyping of union on the right.}%
\label{lem:sub-union-right}
    $\forall \ty, \dctx', \ty'_1, \ty'_2, \AEnv, \text{ s.t. }
    \tyvld{}{\AEnv}\ \land\ \tyvlddflt{\ty, \dctx', \ty'_1, \ty'_2}.$
    \[
        \subtydflt{\ty}{\tyunion{\plug{\dctx'}{\ty'_1}}{\plug{\dctx'}{\ty'_2}}}
        \quad\implies\quad
        \subtydflt{\ty}{\plug{\dctx'}{\tyunion{\ty'_1}{\ty'_2}}}.
    \]
\end{lemma}
\begin{proof}
    By induction on the derivation of
    \subtydflt{\ty}{\tyunion{\plug{\dctx'}{\ty'_1}}{\plug{\dctx'}{\ty'_2}}}.
    Four cases are possible: \RST{Bot}, \RST{VarLeft}, \RST{UnionLeft}, and
    \RST{UnionRight}. The first three are analogous to the cases of
    \lemref{lem:sub-inner-union-right} (subtyping inner union on the right): 
    inversion, IH, constructor.
    The remaining case is \RST{UnionRight}, subcase $i=1$.
    By inversion, \subtydflt{\ty}{\plug{\dctx'}{\ty'_1}}.
    Thus, the case concludes by \lemref{lem:add-inner-union-right} (adding inner
    union on the right):
    \subtydflt{\ty}{\plug{\dctx'}{\tyunion{\ty'_1}{\ty'_2}}}.
    % bot by bot
    % VarLeft by inversion, IH, VarLeft
    % UnionLeft by inversion, IH, UnionLeft
\end{proof}

\begin{lemma}{Context weakening in subtyping of types.}%
\label{lem:subty-weakening}
    $\forall \AEnv, \ty, \ty'.\ \forall \AEnv' \text{ s.t. }$\\
    $\dom{\AEnv'} \cap \dom{\AEnv} = \varnothing \land 
    (\forall \vany \in \dom{\AEnv'}. 
        \lnot \occ{\vany}{\ty} \land \lnot \occ{\vany}{\ty'}),$
    \[ \subtydflt{\ty}{\ty'} \quad\implies\quad 
    \subty{\concat{\AEnv}{\AEnv'}}{\ty}{\ty'}. \]
\end{lemma}
\begin{proof}
    Straightforward induction on the derivation of \subtydflt{\ty}{\ty'}.
\end{proof}


\begin{theorem}{Transitivity of subtyping of types.}\label{thm:sub-ty-trans}
    $\forall \ty_1, \ty_2, \ty_3, \AEnv, \text{ s.t. }
    \tyvld{}{\AEnv}\ \land\ \tyvlddflt{\ty_1, \ty_2, \ty_3}.$
    \[
        \subtydflt{\ty_1}{\ty_2} \ \ \land\ \  \subtydflt{\ty_2}{\ty_3}
        \quad\implies\quad
        \subtydflt{\ty_1}{\ty_3}.
    \]
\end{theorem}
\begin{proof}
    By strong induction on
    $n = \tymsrdflt{\ty_1} + 2\times\tymsrdflt{\ty_2} + \tymsrdflt{\ty_3}$.
    Cases $n = 1..3$ are not possible as the minimal measure of a type is 1.
    In the inductive step for $n$, the induction hypothesis (IH) states that
    $\forall n'<n. \forall \ty'_1, \ty'_2, \ty'_3 \text{ s.t. }
    n' = \tymsrdflt{\ty'_1} + 2\times\tymsrdflt{\ty'_2} + \tymsrdflt{\ty'_3},$
    it holds that
    \[
        \subtydflt{\ty'_1}{\ty'_2} \ \ \land\ \  \subtydflt{\ty'_2}{\ty'_3}
        \quad\implies\quad
        \subtydflt{\ty'_1}{\ty'_3}.
    \]
    Case analysis on \subtydflt{\ty_2}{\ty_3} (the most interesting cases are
    highlighted in \textbf{bold}).
    \begin{itemize}
        \item Case \RST{Top} \subtydflt{\ty_2}{\tyany} where $\ty_3 = \tyany$
            concludes by \RST{Top}: \subtydflt{\ty_1}{\tyany}.
        \item Case \RSS{Bot} \subtydflt{\plug\dctx\tybot}{\ty_3}
            where $\ty_2=\plug\dctx\tybot$.
            The case concludes by \lemref{lem:sub-of-bot}
            (subtyping of \tybot) applied
            to the assumption \subtydflt{\ty_1}{\plug\dctx\tybot}
            with $\dctx' = \square, \ty' = \ty_3$:
            \subtydflt{\ty_1}{\ty_3}.
        \item Case \RST{VarRefl} \subtydflt{\vany}{\vany}.
            Since $\ty_2=\ty_3=\vany$, the case concludes by the assumption
            \subtydflt{\ty_1}{\vany}.
        \item \textbf{Case \RST{VarLeft}} \subtydflt{\plug\dctx\vany}{\ty_3} 
            where $\ty_2 = \plug\dctx\vany$.
            By inversion, $\varbound{\vany}{\tylb}{\tyub} \in \AEnv$ and
            \subtydflt{\plug\dctx{\tyub}}{\ty_3}.
            By assumption, \subtydflt{\ty_1}{\plug\dctx\vany}.
            We will need the following auxiliary fact.

            \begin{lemma}\label{lem:sub-var-right-sub-ub}
                \subtydflt{\ty_1}{\plug\dctx\tyub}.
            \end{lemma}
            \begin{proof}
                By induction on \subtydflt{\ty_1}{\plug\dctx\vany}.
                \begin{itemize}
                    \item Case \RST{Bot} by \RST{Bot}.
                    \item Case \RST{VarRefl} \subtydflt{\vany}{\vany}.
                        By \thmref{thm:sub-ty-refl} (reflexivity),
                        \subtydflt{\tyub}{\tyub}.
                        Thus, by \RST{VarLeft}, \subtydflt{\vany}{\tyub}.
                    \item Case \RST{VarLeft} 
                        \subtydflt{\plug{\dctx'}{\vany'}}{\plug\dctx\vany}.
                        By inversion, $\varbound{\vany'}{\tylb'}{\tyub'} \in \AEnv$
                        and \subtydflt{\plug{\dctx'}{\tyub'}}{\plug\dctx\vany}.
                        By IH,
                        \subtydflt{\plug{\dctx'}{\tyub'}}{\plug\dctx\tyub}.
                        Thus, by \RST{VarLeft},
                        \subtydflt{\plug{\dctx'}{\vany'}}{\plug\dctx\tyub}.
                    \item \textbf{Case \RST{VarRight}} \subtydflt{\ty_1}{\vany}.
                        By inversion, $\varbound{\vany}{\tylb}{\tyub} \in \AEnv$
                        and \subtydflt{\ty_1}{\tylb}.
                        By inversion of the assumptions \tyvlddflt{\vany} and
                        \tyvld{\,}{\AEnv} and by~\lemref{lem:subty-weakening}
                        (context weakening), we have \subtydflt{\tylb}{\tyub}.

                        Since $\ty_2 = \vany$ and $\tymsrdflt{\vany} = 
                        1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub}$, we have
                        $\tymsrdflt{\ty_1} + 2\times\tymsrdflt{\tylb} + 
                        \tymsrdflt{\tyub} < \tymsrdflt{\ty_1} + 
                        2\times\tymsrdflt{\vany} + \tymsrdflt{\ty_3}$. Thus,
                        IH for \emph{transitivity} is applicable to 
                        \subtydflt{\ty_1}{\tylb} and \subtydflt{\tylb}{\tyub},
                        which concludes the case with \subtydflt{\ty_1}{\tyub}.
                    \item Case \RST{Tuple}, subcase
                        $\dctx = \typair{\dctx'}{\ty_{22}}$
                        ($\dctx = \square$ is not possible, and
                        $\dctx = \typair{\ty_{21}}{\dctx'}$
                        is proved analogously), i.e.
                        \subtydflt
                            {\typair{\ty_{11}}{\ty_{12}}}
                            {\typair{\plug{\dctx'}\vany}{\ty_{22}}}.
                        By inversion, \subtydflt{\ty_{11}}{\plug{\dctx'}\vany}
                        and \subtydflt{\ty_{12}}{\ty_{22}}.
                        By IH, \subtydflt{\ty_{11}}{\plug{\dctx'}\tyub}.
                        Thus, by \RST{Tuple},
                        \subtydflt
                            {\typair{\ty_{11}}{\ty_{12}}}
                            {\typair{\plug{\dctx'}\tyub}{\ty_{22}}}.
                    \item Case \RST{UnionLeft} is proved analogously 
                        to \RST{Tuple}: by inversion, IH, and \RST{UnionLeft}.
                \end{itemize}
                The remaining cases
                (\RST{Top}, \RST{Tuple}, \RST{Inv}, \RST{UnionRight}) 
                are not possible.
            \end{proof}

            Be \lemref{lem:sub-var-right-sub-ub} above,
            \subtydflt{\ty_1}{\plug\dctx\tyub}.
            Since $\ty_2 = \plug\dctx\vany$ and 
            $\tymsrdflt{\tyub} < \tymsrdflt{\vany}$,
            IH is applicable to \subtydflt{\ty_1}{\plug\dctx\tyub} and 
            \subtydflt{\plug\dctx\tyub}{\ty_3}, which concludes the case with
            \subtydflt{\ty_1}{\ty_3}.
        \item Case \RST{VarRight} \subtydflt{\ty_2}{\vany}.
            By inversion, $\varbound{\vany}{\tylb}{\tyub} \in \AEnv$ and
            \subtydflt{\ty_2}{\tylb}.
            Since $\tymsrdflt{\tylb} < \tymsrdflt{\vany}$, by IH,
            \subtydflt{\ty_1}{\tylb}.
            Thus, by \RST{VarRight}, \subtydflt{\ty_1}{\vany}.
        \item Case \RST{Tuple} 
            \subtydflt{\typair{\ty_{21}}{\ty_{22}}}{\typair{\ty_{31}}{\ty_{32}}}
            where $\ty_i = \typair{\ty_{i1}}{\ty_{i2}}$.
            Case analysis on \subtydflt{\ty_1}{\typair{\ty_{21}}{\ty_{22}}}.
            \begin{itemize}
                \item Case \RST{Bot} by \RST{Bot}.
                \item Case \RST{VarLeft} by inversion, IH on 
                    \subtydflt{\plug\dctx\tyub}{\ty_2} and
                    \subtydflt{\ty_2}{\ty_3}, and \RST{VarLeft} on
                    \subtydflt{\plug\dctx\tyub}{\ty_3}.
                \item Case \RST{Tuple} by inversion, IH on
                    \subtydflt{\ty_{1j}}{\ty_{2j}} and 
                    \subtydflt{\ty_{2j}}{\ty_{3j}}, and \RST{Tuple}.
                \item Case \RST{UnionLeft} 
                    \subtydflt{\plug\dctx{\tyunion{\ty_{11}}{\ty_{12}}}}{\ty_2}
                    by inversion, IH on
                    \subtydflt{\plug\dctx{\ty_{1j}}}{\ty_2} and
                    \subtydflt{\ty_2}{\ty_3}, and \RST{UnionLeft}.
            \end{itemize}
            The remaining cases
            (\RST{Top}, \RST{VarRefl}, \RST{VarRight}, \RST{Inv}, \RST{UnionRight}) 
            are not possible.
        \item Case \RST{Inv} is proved similarly to \RST{Tuple}, with
            possible cases of \subtydflt{\ty_1}{\ty_2} being
            \RST{Bot}, \RST{VarLeft}, \RST{Inv}, and \RST{UnionLeft}.
        \item \textbf{Case \RST{UnionLeft}} 
            \subtydflt{\plug\dctx{\tyunion{\ty_{21}}{\ty_{22}}}}{\ty_3}.
            By \lemref{lem:sub-inner-union-right} applied to
            \subtydflt{\ty_1}{\plug\dctx{\tyunion{\ty_{21}}{\ty_{22}}}}
            with $\dctx_1=\square,\dctx_2=\square$,
            \subtydflt{\ty_1}{\tyunion{\plug\dctx{\ty_{21}}}{\plug\dctx{\ty_{22}}}}.
            Case analysis on the latter.
            \begin{itemize}
                \item Case \RST{Bot} by \RST{Bot}.
                \item Case \RST{VarLeft} where $\ty_1 = \plug{\dctx'}\vany$.
                    By inversion, $\varbound{\vany}{\tylb}{\tyub} \in \AEnv$ and
                    \subtydflt{\plug{\dctx'}\tyub}
                    {\tyunion{\plug\dctx{\ty_{21}}}{\plug\dctx{\ty_{22}}}}.
                    By \lemref{lem:sub-union-right} applied to the latter,
                    \subtydflt{\plug{\dctx'}\tyub}
                    {\plug\dctx{\tyunion{\ty_{21}}{\ty_{22}}}}.

                    Since $\tymsrdflt{\tyub} < \tymsrdflt{\vany}$, by IH,
                    \subtydflt{\plug{\dctx'}\tyub}{\ty_3}.
                    Thus, the case concludes by \RST{VarLeft}:
                    \subtydflt{\plug{\dctx'}\vany}{\ty_3}.
                \item Case \RST{UnionLeft} similarly to \RST{VarLeft}.
                \item Case \RST{UnionRight}, subcase $i=1$.
                    By inversion, \subtydflt{\ty_1}{\plug\dctx{\ty_{21}}}.
                    By inversion of the outer case assumption
                    \subtydflt{\plug\dctx{\tyunion{\ty_{21}}{\ty_{22}}}}{\ty_3},
                    \subtydflt{\plug\dctx{\ty_{21}}}{\ty_3}.
                    Since $\tymsrdflt{\plug\dctx{\ty_{21}}} < 
                    \tymsrdflt{\plug\dctx{\tyunion{\ty_{21}}{\ty_{22}}}}$,
                    by IH, \subtydflt{\ty_1}{\ty_3}.
            \end{itemize}
            The remaining cases
            (\RST{Top}, \RST{VarRefl}, \RST{VarRight}, \RST{Tuple}, \RST{Inv}) 
            are not possible.
        \item Case \RST{UnionRight} 
            \subtydflt{\ty_2}{\tyunion{\ty_{31}}{\ty_{32}}} where 
            $\ty_3 = \tyunion{\ty_{31}}{\ty_{32}}$, subcase $i=1$.
            By inversion, \subtydflt{\ty_2}{\ty_{31}}. Since
            $\tymsrdflt{\ty_{31}} < \tymsrdflt{\tyunion{\ty_{31}}{\ty_{32}}}$,
            by IH, \subtydflt{\ty_1}{\ty_{31}}.
            Thus, the case concludes by \RST{UnionRight}.
    \end{itemize}
\end{proof}

%% This fact we use implicitly
% \begin{lemma}{Preservation of subtyping by distributivity context.}%
%     \[
%         \forall \AEnv, \dctx, \ty, \ty'.\quad
%         \subtydflt{\ty}{\ty'} \quad\implies\quad
%         \subtydflt{\plug\dctx\ty}{\plug\dctx{\ty'}}.
%      \]
% \end{lemma}
% \begin{proof}
%     Straightforward by induction on the structure of \dctx,
%     using the assumption \subtydflt{\ty}{\ty'} in the base case
%     and \thmref{thm:sub-ty-refl} (reflexivity) in the inductive cases.
% \end{proof}

\begin{figure}
\footnotesize
\begin{mathpar}
    \fbox{\vldinenvdflt{\substvars}}
    \\

    \inferrule*[]
    { \forall \varbound{\vany}{\tylb}{\tyub} \in \AEnv. \and
        \tyvld{\AEnv'}{\substvars(\vany)} \and
        \subty{\AEnv'}{\substvars(\tylb)}{\substvars(\vany)} \and 
        \subty{\AEnv'}{\substvars(\vany)}{\substvars(\tyub)} }
    { \vldinenvdflt{\substvars} }
    
    \\
    \fbox{\vldinenv{\AEnv}{\CSet}{\substvars}}
    \\

    \inferrule*[]
    { \forall \ctrsub{\ty}{\va} \in \CSet.\ \ 
        \subtydflt{\ty}{\substvars(\va)} \and 
        \forall \ctrsub{\va}{\ty'} \in \CSet.\ \  
        \subtydflt{\substvars(\va)}{\ty'} }
    { \vldinenv{\AEnv}{\CSet}{\substvars} }
\end{mathpar}
\caption{Validity of substitution with respect to environment and constrains}%
\label{fig:substuvars-validity}
\end{figure}

\begin{theorem}{Soundness of subtyping of types with respect to subsitution.}%
\label{thm:subty-sound-subst}
    $\forall \AEnv, \ty, \ty' \text{ s.t. } \tyvld{}{\AEnv}\ \land\ 
        \tyvlddflt{\ty, \ty'}.\ 
     \forall \AEnv', \substvars \text{ s.t. } \tyvld{}{\AEnv'}\ \land\ 
        \vldinenvdflt{\substvars}.$
     \[ 
        \subtydflt{\ty}{\ty'} \quad\implies\quad
        \subty{\AEnv'}{\substvars(\ty)}{\substvars(\ty')}.
     \]
    where \vldinenvdflt{\substvars} is defined
    in \figref{fig:substuvars-validity}.
\end{theorem}
\begin{proof}
    By induction on the derivation of \subtydflt{\ty}{\ty'}.

    Cases \RST{Top} and \RST{Bot} are straightforward by \RST{Top} and
    \RST{Bot}, respectively. 

    Case \RST{VarRefl} by \thmref{thm:sub-ty-refl} (reflexivity):
    \subty{\AEnv'}{\substvars(\vany)}{\substvars(\vany)}.

    Cases \RST{Tuple}, \RST{Inv}, \RST{UnionLeft}, and \RST{UnionRight} are
    straightforward using inversion, the induction hypothesis, and constructor.
    For example, consider the case \RST{Tuple}
    \subtydflt{\typair{\ty_1}{\ty_2}}{\typair{\ty'_1}{\ty'_2}}.
    By inversion, \subtydflt{\ty_i}{\ty'_i}.
    By IH, \subty{\AEnv'}{\substvars(\ty_i)}{\substvars(\ty'_i)}.
    The case concludes by \RST{Tuple} with 
    \[\subty{\AEnv'}{\typair{\substvars(\ty_1)}{\substvars(\ty_2)}}
    {\typair{\substvars(\ty'_1)}{\substvars(\ty'_2)}}\]
    and the fact that $\substvars(\typair{\ty_1}{\ty_2}) = 
    \typair{\substvars(\ty_1)}{\substvars(\ty_2)}.$

    The remaining cases \RST{VarLeft} and \RST{VarRight} are similar.
    For example, consider \RST{VarLeft} \subtydflt{\plug{\dctx}\vany}{\ty'}.
    By inversion, $\varbound{\vany}{\tylb}{\tyub} \in \AEnv$ and
    \subtydflt{\plug\dctx{\tyub}}{\ty'}.
    By IH, \subty{\AEnv'}{\substvars(\plug\dctx{\tyub})}{\substvars(\ty')}.
    By inversion of the assumption \vldinenvdflt{\substvars}, we know
    \subty{\AEnv'}{\substvars(\vany)}{\substvars(\tyub)}.
    Since $\substvars(\plug\dctx{\tyub}) = 
    \plug{\substvars(\dctx)}{\substvars(\tyub)}$ and
    \subty{\AEnv'}{\substvars(\dctx)}{\substvars(\dctx)} by reflexivity,
    we have \subty{\AEnv'}{\plug{\substvars(\dctx)}{\substvars(\vany)}}
    {\plug{\substvars(\dctx)}{\substvars(\tyub)}}.
    The case concludes by \thmref{thm:sub-ty-trans} (transitivity) with the
    middle type $\substvars(\plug\dctx{\tyub})$:
    \[\subty{\AEnv'}{\substvars(\plug\dctx{\vany})}{\substvars(\ty')}.\]
\end{proof}


\subsection{Intersection}%
\label{subsec:props-join-meet-proof}
%% ======================================================================

% \begin{theorem}{Soundness of join.}%
% \label{thm:join-sound}
%     \tyjoindflt{\ty}{\ty'} computes a join of $\ty, \ty'$, namely:
%     $\forall \AEnv, \ty, \ty'$ s.t. \tyvld{}{\AEnv}
%     and \tyvlddflt{\ty, \ty'}.
%     \begin{enumerate}
%         \item \tyjoindflt{\ty}{\ty'} is a valid upper bound
%             of \ty and $\ty'$, i.e., 
%             \[
%                 \tyvlddflt{\tyjoindflt{\ty}{\ty'}}
%                 \quad\text{and}\quad
%                 \subtydflt{\ty}{(\tyjoindflt{\ty}{\ty'})}
%                 \quad\text{and}\quad
%                 \subtydflt{\ty'}{(\tyjoindflt{\ty}{\ty'})};
%             \]
%         \item \tyjoindflt{\ty}{\ty'} is the least upper bound
%             of \ty and $\ty'$, i.e.,
%             $\forall \tyub$ s.t. \tyvlddflt{\tyub},
%             \subtydflt{\ty}{\tyub} and \subtydflt{\ty'}{\tyub}.
%             \[
%                 \subtydflt{(\tyjoindflt{\ty}{\ty'})}{\tyub}.
%             \]
%     \end{enumerate}
% \end{theorem}
% \begin{proof}
%     Straightforward by the definition of $\sqcup_{\AEnv}$,
%     using \thmref{thm:sub-ty-refl} (reflexivity), 
%     \RST{UnionLeft}, and \RST{UnionRight}.
% \end{proof}

% \begin{lemma}{Symmetry of join.}
%     $\forall \AEnv, \ty, \ty'$ s.t. \tyvlddflt{\ty, \ty'}.
%     \[
%         \subtydflt{(\tyjoindflt{\ty}{\ty'})}{(\tyjoindflt{\ty'}{\ty})}
%         \quad\text{and}\quad
%         \subtydflt{(\tyjoindflt{\ty'}{\ty})}{(\tyjoindflt{\ty}{\ty'})}.
%     \]
% \end{lemma}
% \begin{proof}
%     Straightforward by the definition of $\sqcup_{\AEnv}$,
%     using \thmref{thm:sub-ty-refl} (reflexivity), 
%     \RST{UnionLeft}, and \RST{UnionRight}.
% \end{proof}

\begin{theorem}{Soundness of intersection.}%
\label{thm:meet-sound}
    \tymeetdflt{\ty}{\ty'} defines an intersection of $\ty, \ty'$, namely:
    $\forall \AEnv, \ty, \ty'$ s.t. \tyvld{}{\AEnv}
    and \tyvlddflt{\ty, \ty'}.
    \tymeetdflt{\ty}{\ty'} is a valid lower bound
    of \ty and $\ty'$, i.e., 
    \[
        \tyvlddflt{\tymeetdflt{\ty}{\ty'}}
        \quad\text{and}\quad
        \subtydflt{(\tymeetdflt{\ty}{\ty'})}{\ty}
        \quad\text{and}\quad
        \subtydflt{(\tymeetdflt{\ty}{\ty'})}{\ty'}.
    \]
    % \begin{enumerate}
    %     \item \tymeetdflt{\ty}{\ty'} is a valid lower bound
    %         of \ty and $\ty'$, i.e., 
    %         \[
    %             \tyvlddflt{\tymeetdflt{\ty}{\ty'}}
    %             \quad\text{and}\quad
    %             \subtydflt{(\tymeetdflt{\ty}{\ty'})}{\ty}
    %             \quad\text{and}\quad
    %             \subtydflt{(\tymeetdflt{\ty}{\ty'})}{\ty'}.
    %         \]
    %     \item \tymeetdflt{\ty}{\ty'} is the least upper bound
    %         of \ty and $\ty'$, i.e.,
    %         $\forall \tylb$ s.t. \tyvlddflt{\tylb},
    %         \subtydflt{\tylb}{\ty} and \subtydflt{\tylb}{\ty'}.
    %         \[
    %             \subtydflt{\tylb}{(\tymeetdflt{\ty}{\ty'})}.
    %         \]
    % \end{enumerate}
\end{theorem}
\begin{proof}
    %\TODO{either prove the second part or rename meet}
    Straightforward by strong induction on
    $\tymsrdflt{\ty} + \tymsrdflt{\ty'}$.
    %and induction on the derivation of \subty.

    For example, the case where \subtydflt{\ty}{\ty'} follows from
    the assumptions and reflexivity \subtydflt{\ty}{\ty}.

    In the case \tymeetdflt{(\tyunion{\ty_1}{\ty_2})}{\ty'},
    we know by IH that \tymeetdflt{\ty_1}{\ty'} and \tymeetdflt{\ty_2}{\ty'}
    are valid lower bounds of $\ty_1,\ty'$ and $\ty_2,\ty'$, respectively.
    Thus, the case concludes by \RST{UnionLeft}.

    In the case \tymeetdflt{\vany}{\ty'}, we have \subtydflt{\tylb}{\vany}
    by \thmref{thm:sub-ty-refl} (reflexivity) and \RST{VarRight}.
    Then, by IH, \subtydflt{\tymeetdflt{\tylb}{\ty'}}{\tylb}.
    The case concludes by \thmref{thm:sub-ty-trans} (transitivity):
    \subtydflt{\tymeetdflt{\tylb}{\ty'}}{\vany}.
    
    The remaining cases for tuples and invariant constructors
    use the induction hypotheses and constructors \RST{Tuple} and \RST{Inv},
    respectively, as well as \RST{UnionLeft}
    %\thmref{thm:join-sound} (soundness of join)
    in the invariant case.

    The catch-all case $\tymeetdflt{\ty}{\ty'} = \tybot$
    follows from \RST{Bot}.
\end{proof}

% \begin{lemma}{Symmetry of meet.}
%     $\forall \AEnv, \ty, \ty'$ s.t. \tyvlddflt{\ty, \ty'}.
%     \[
%         \subtydflt{(\tymeetdflt{\ty}{\ty'})}{(\tymeetdflt{\ty'}{\ty})}
%         \quad\text{and}\quad
%         \subtydflt{(\tymeetdflt{\ty'}{\ty})}{(\tymeetdflt{\ty}{\ty'})}.
%     \]
% \end{lemma}
% \begin{proof}
%     Straightforward by strong induction on
%     $\tymsrdflt{\ty} + \tymsrdflt{\ty'}$,
%     using the definition of $\sqcap_{\AEnv}$,
%     \thmref{thm:sub-ty-refl} (reflexivity),
%     and \RST{} constructors.
% \end{proof}

\subsection{Constrained Subtyping}%
\label{subsec:props-subtyctr-proof}
%% ======================================================================

This section presents the following key properties:
\begin{itemize}
    \item \subtydflt{\ty}{\ty'} and \subtyctrdflt{\ty}{\ty'} coincide on
        unification-free types (\lemref{lem:subtyctr-subty});
    \item soundness of \subtyctrdflt{\ty}{\ty'}
        (\thmref{thm:subtyctr-sound});
    \item soundness of \solvectrdflt (\thmref{thm:solvectr-sound}).
\end{itemize}

\begin{lemma}{Constrained subtyping coincides with subtyping on
    unification-free types.}%
\label{lem:subtyctr-subty}
    $\forall \AEnv, \ty, \ty' \text{ s.t. } 
    \tyvld{}{\AEnv} \ \land\ \tyvlddflt{\ty} \ \land\ \tyvlddflt{\ty'}$ 
    the following holds:
    \begin{enumerate}
        \item $\forall \UEnvD.\ \subtyctrdflt{\ty}{\ty'} \quad\implies\quad
            \CSet = \EmptyCSet\ \land\ \subtydflt{\ty}{\ty'};$
        \item $\subtydflt{\ty}{\ty'} \quad\implies\quad 
            \forall \UEnvD.\ \subtyctrdfltenv{\ty}{\ty'}{\EmptyCSet}.$
    \end{enumerate}
\end{lemma}
\begin{proof}
    Straightforward by induction on the derivation of:
    \begin{enumerate}
        \item \subtyctrdflt{\ty}{\ty'} (more precisely, by mutual induction
            on \subtyctrLdflt{\ty}{\ty'} and \subtyctrRdflt{\ty}{\ty'});
        \item \subtydflt{\ty}{\ty'}.
    \end{enumerate}

    In the first case, the rules \RSC{UBot}, \RSC{UVarLeft}, \RSC{UVarRight},
    and \RSC{UVar-UnionRight} could not have been used to build the derivation
    because they refer to a unification variable \va from \UEnvD,
    and both \ty and $\ty'$ are valid in \AEnv alone.
    All other rules of constrained subtyping have matching subtyping rules.

    In the second case, all subtyping rules have matching rules of constrained
    subtyping.
    The assumption \tyvld{}{\AEnv} and \lemref{lem:subty-weakening} (context
    weakening) allow for concluding 
    \tyvlddflt{\plug\dctx\tyub} and \tyvlddflt{\tylb} 
    to apply the induction hypothesis in the rules
    \RSC{VarLeft}/\RST{VarLeft} and \RSC{VarRight}/\RST{VarRight}.
\end{proof}

\begin{theorem}{Soundness of constrained subtyping.}%
\label{thm:subtyctr-sound}
    $\forall \AEnv, \UEnvD, \ty, \ty' \text{ s.t. } \tyvld{}{\AEnv},$ if
    \[\subtyctrRdflt{\ty}{\ty'} \ \land\ 
        \tyvlddflt{\ty} \ \land\  \tyunfvlddflt{\ty'}\] 
    or
    \[\subtyctrLdflt{\ty}{\ty'} \ \land\ 
        \tyunfvlddflt{\ty} \ \land\  \tyvlddflt{\ty'},\]
    then $\forall \substvars \text{ s.t. } 
        \dom{\substvars} \supseteq \UEnvD \ \land\ 
        \dom{\substvars} \cap \dom{\AEnv} = \varnothing \ \land\ 
        \vldinenv{\AEnv}{\CSet}{\substvars}.$
     \[ 
        \subtydflt{\substvars(\ty)}{\substvars(\ty')}.
     \]
\end{theorem}
\begin{proof}
    By strong induction on $\tymsrdflt{\ty} + \tymsrdflt{\ty'}.$
    \begin{itemize}
        \item Case \RSC{Top} \subtyctrdfltenv{\ty}{\tyany}{\EmptyCSet}.
            By definition, $\substvars(\tyany) = \tyany$.
            Thus, the case concludes by \RST{Top}:
            \subtydflt{\substvars(\ty)}{\tyany}.
        \item Case \RSC{Bot} by \RST{Bot}, similarly to \RSC{Top}.
        \item Case \RSC{UBot}
            \subtyctrLdfltenv{\plug\dctx\va}{\ty'}{\ctrsngl\va\tybot}.
            Since $\substvars(\plug\dctx\va) = 
                \plug{\substvars(\dctx)}{\substvars(\va)} = 
                \plug{\dctx'}{\substvars(\va)}$ for some $\dctx'$
            and by assumption, \subtydflt{\substvars(\va)}{\tybot},
            we have \subtydflt{\plug{\dctx'}{\substvars(\va)}}{\plug{\dctx'}\tybot}.
            By \RST{Bot}, \subtydflt{\plug{\dctx'}\tybot}{\substvars(\ty')}.
            Therefore, the case concludes by transitivity:
            \subtydflt{\plug{\dctx'}{\substvars(\va)}}{\substvars(\ty')}.
        \item Case \RSC{VarRefl} by \RST{VarRefl}, for $\substvars(\vx) = \vx.$
        \item Case \RSC{UVarLeft} 
            \subtyctrLdfltenv{\va}{\ty'}{\ctrsngl{\va}{\ty'}} by assumption
            \subtydflt{\substvars(\va)}{\ty'}, since $\substvars(\ty') = \ty'$
            due to \tyvlddflt{\ty'}.
        \item Case \RSC{UVarRight} similarly to \RSC{UVarLeft}.
        \item Case \RSC{VarLeft} (\RSC{VarRight}) by inversion, IH, and
            \RST{VarLeft} (\RST{VarRight}), for $\substvars(\vx) = \vx$
            and $\substvars(\tyub) = \tyub$ ($\substvars(\tylb) = \tylb$).
        \item Cases \RSC{Tuple}, \RSC{Inv}, \RSC{UnionLeft}, and \RSC{UnionRight}
            are all similar: by inversion, IH, and the corresponding subtyping
            constructor.
        \item \textbf{Case \RSC{UVar-UnionRight}} 
            \subtyctrLdfltenv{\plug\dctx{\va}}{\tyunion{\ty'_1}{\ty'_2}}
            {\CSet'_1 \cup \CSet'_2 \cup \CSet'}.
            Since \tyvlddflt{\tyunion{\ty'_1}{\ty'_2}}, we have
            $\substvars(\tyunion{\ty'_1}{\ty'_2}) = \tyunion{\ty'_1}{\ty'_2}.$
            By assumption,
            \vldinenv{\AEnv}{\CSet'_1 \cup \CSet'_2 \cup \CSet'}{\substvars}.
            By inversion, 
            \subtyctrL{\AEnv}{\UEnvD,\va_1}{\plug\dctx{\va_1}}{\ty'_1}{\CSet_1} 
            and
            \subtyctrL{\AEnv}{\UEnvD,\va_2}{\plug\dctx{\va_2}}{\ty'_2}{\CSet_2},
            where $\CSet_1 = \CSet'_1 \mcup_{i=1}^n \ctrset{\ctrsub{\va_1}{\tyub_1^i}}$
            and $\CSet_2 = \CSet'_2 \mcup_{j=1}^m \ctrset{\ctrsub{\va_2}{\tyub_2^j}}$.
            
            When $n=0$ or $m=0$, we can take $\substvars_1 = 
                \subst{\substvars}{\substel{\va_1}{\substvars(\va)}}$
            and $\substvars_2 = 
                \subst{\substvars}{\substel{\va_2}{\substvars(\va)}}$.
            In both subcases ($n=0$ and $m=0$), we have 
            \vldinenv{\AEnv}{\CSet_1}{\substvars_1} and
            \vldinenv{\AEnv}{\CSet_2}{\substvars_2}, because $\substvars(\va)$
            satisfies the constraints on $\va_1$ and $\va_2$.
            Therefore, by the induction hypotheses,
            \subtydflt{\substvars_1(\plug\dctx{\va_1})}{\tyunion{\ty'_1}{\ty'_2}}
            and
            \subtydflt{\substvars_2(\plug\dctx{\va_2})}{\tyunion{\ty'_1}{\ty'_2}}.
            Clearly, $\substvars(\plug\dctx{\va}) = 
                \substvars_1(\plug\dctx{\va_1}) = 
                \substvars_2(\plug\dctx{\va_2})$,
            and thus, the subcases conclude by \RST{UnionRight}.

            The most interesting case is when $n \geq 1, m \geq 1$.
            Let $\msqcap_{i=1}^n \tyub_1^i$ be denoted with $\tyub_1$
            and $\msqcap_{j=1}^m \tyub_2^j$ with $\tyub_2$.
            By~\thmref{thm:meet-sound} (soundness of intersection), we have
            \subtydflt{\tyub_1}{\tyub_1^i} and \subtydflt{\tyub_2}{\tyub_2^j}
            for all $i, j$. Therefore, we can take 
            $\substvars_1 = \subst{\substvars}{\substel{\va_1}{\tyub_1}}$ and
            $\substvars_2 = \subst{\substvars}{\substel{\va_2}{\tyub_2}}$,
            and it holds that \vldinenv{\AEnv}{\CSet_1}{\substvars_1} and
            \vldinenv{\AEnv}{\CSet_2}{\substvars_2}.
            Therefore, the induction hypotheses are applicable, and we get
            \subtydflt{\plug{\substvars_1(\dctx)}{\tyub_1}}{\ty'_1} (H$_1$) and
            \subtydflt{\plug{\substvars_2(\dctx)}{\tyub_2}}{\ty'_2} (H$_2$).
            By assumption on \substvars, we have
            \subtydflt{\substvars(\va)}{\tyunion{\tyub_1}{\tyub_2}}.
            Therefore, \[\subtydflt{\plug{\substvars(\dctx)}{\substvars(\va)}}
                {\plug{\substvars(\dctx)}{\tyunion{\tyub_1}{\tyub_2}}}.\]
            Since $\va_1, \va_2$ were fresh, we know
            $\substvars(\dctx) = \substvars_1(\dctx) = \substvars_2(\dctx)$.
            Therefore, by \RST{UnionLeft} applied to H$_1$, H$_2$, we have
            \[\subtydflt{\plug{\substvars(\dctx)}{\tyunion{\tyub_1}{\tyub_2}}}
                {\tyunion{\ty'_1}{\ty'_2}}.\]
            Finally, the subcase $n \geq 1, m \geq 1$ concludes by transitivity:
            \[\subtydflt{\plug{\substvars(\dctx)}{\substvars(\va)}}{\tyunion{\ty'_1}{\ty'_2}}.\]
    \end{itemize}
\end{proof}

\begin{theorem}{Soundness of constrains resolution.}%
\label{thm:solvectr-sound}
    $\forall \AEnv, \UEnv$ s.t. $\tyvld{}{\AEnv, \UEnv}$.
    $\forall \CSet$ s.t. $\forall \ctrsub{\tylb}{\va} \in \CSet.
        \ \tyvlddflt{\tylb}\ \land\ \tyvld{\UEnv}{\va}$ and 
        $\forall \ctrsub{\va}{\tyub} \in \CSet.
        \ \tyvld{\UEnv}{\va} \ \land\ \tyvlddflt{\tyub}.$
    \[
        \solvectrdflt = \substvars
        \quad\implies\quad
        \vldinenv{\AEnv}{\UEnv}{\substvars}\ \ \land\ \ 
        \vldinenv{\AEnv}{\CSet}{\substvars}.
    \]
    where \vldinenv{\AEnv}{\UEnv}{\substvars} and
    \vldinenv{\AEnv}{\CSet}{\substvars} are defined
    in \figref{fig:substuvars-validity}.
\end{theorem}
\begin{proof}
    By induction on \UEnv. The base case is trivial ($\CSet = \EmptyCSet$
    because $\UEnv = \EmptyEnv$).

    In the inductive step $\UEnv,\varbound{\va}{\tylb}{\tyub}$,
    the induction hypothesis applies to the call \solvectr{\AEnv}{\UEnv}{
        \CSet' \mcup_i \CSet_{\tylb_i} \mcup_j \CSet_{\tyub_j}
    }, which returns \substvars.
    Therefore, we know that \vldinenv{\AEnv}{\UEnv}{\substvars} and
    \vldinenv{\AEnv}{\CSet' \mcup_i \CSet_{\tylb_i} \mcup_j \CSet_{\tyub_j}}{\substvars}.

    Let $\substvars(\tylb) \mcup_i \tylb_i$ be denoted with $\ty_{\va}$
    and \subst\substvars{\substel{\va}{\ty_{\va}}} with $\substvars_{\va}.$
    %be denoted with $\substvars_{\va}.$
    By~\thmref{thm:subtyctr-sound} (soundness of constrained subtyping)
    applied to \subtyctrRdfltenv{\tylb_i}{\tyub}{\CSet_{\tylb_i}} with
    \vldinenv{\AEnv}{\CSet_{\tylb_i}}{\substvars} and
    \subtyctrLdfltenv{\tylb}{\tyub_j}{\CSet_{\tyub_j}} with
    \vldinenv{\AEnv}{\CSet_{\tyub_j}}{\substvars},
    we know 
    \[
        \subtydflt{\tylb_i}{\substvars(\tyub)}\ (\textrm{H}_{l_i})\ 
        \ \text{ and }\ 
        \subtydflt{\substvars(\tylb)}{\tyub_j}\ (\textrm{H}_{u_j}).
    \]
    % Since $\lnot\occ{\va}{\tylb}, \lnot\occ{\va}{\tyub}$, we have
    % $\substvars(\tylb) = \substvars_{\va}(\tylb)$ and
    % $\substvars(\tyub) = \substvars_{\va}(\tyub)$.
    By \RST{UnionRight} and reflexivity, we know 
    \subtydflt{\substvars(\tylb)}{\ty_{\va}}.
    By \thmref{thm:subty-sound-subst} (soundness of subtyping with respect to
    substitution), \subtydflt{\substvars(\tylb)}{\substvars(\tyub)} (H),
    for \subty{\UEnv}{\tylb}{\tyub} by the \UEnv validity assumption. 
    Thus, we have %\subtydflt{\substvars(\tylb)}{\ty_{\va}} and
    \subtydflt{\ty_{\va}}{\substvars(\tyub)}
    by \RST{UnionLeft}, H, and H$_{l_i}$.
    Since \vldinenv{\AEnv}{\UEnv}{\substvars} and \va does not occur in \UEnv,
    it holds that \vldinenv{\AEnv}{\UEnv}{\substvars_{\va}}, and we get 
    \[ \vldinenv{\AEnv}{\UEnv, \varbound{\va}{\tylb}{\tyub}}{\substvars_{\va}}. \]

    Finally, we know that $\forall i,j,$ \subtydflt{\tylb_i}{\ty_{\va}} holds by
    \RST{UnionRight} and reflexivity, and \subtydflt{\ty_{\va}}{\tyub_j} holds
    by \RST{UnionLeft}, H$_{u_j}$, and \subtydflt{\tylb_i}{\tyub_j},
    which means \vldinenv{\AEnv}{\CSet_{\va}}{\substvars_{\va}}.
    Since \va does not occur in $\CSet'$, we also know 
    \vldinenv{\AEnv}{\CSet'}{\substvars_{\va}}.
    Thus, \vldinenv{\AEnv}{\CSet}{\substvars_{\va}}, which concludes the proof.
\end{proof}

