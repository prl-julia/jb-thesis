\section{Proofs}

\subsection{Decidability of Subtyping}\label{subsec:dec-proof}
%% ======================================================================

\begin{figure}
\footnotesize
\[
\begin{array}{lcl}
    \hline
    \multicolumn{3}{c}{\tymsrdflt{\ty}} \\ 
    \hline 
    \tymsrdflt{\tyany} &::=& 1\\
    \tymsrdflt{\tybot} &::=& 1\\
    \tymsr{\,\EmptyEnv\,}{\vany} &::=& 1\\
    \tymsr{\AEnv, \varbound{\vany}{\tylb}{\tyub}}{\vany} &::=& 
        1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub}\\
    \tymsr{\AEnv, \varbound{\vany'}{\tylb}{\tyub}}{\vany} &::=& 
        \tymsrdflt{\vany} \\
    \tymsrdflt{\typair{\ty_1}{\ty_2}} &::=& 
        1 + \tymsrdflt{\ty_1} + \tymsrdflt{\ty_2}\\
    \tymsrdflt{\tyinv\iname{\rexvar_1,\ldots,\rexvar_n}} &::=&
        1 + \tymsrdflt{\rexvar_1} + \ldots + \tymsrdflt{\rexvar_n}\\
    \tymsrdflt{\tyunion{\ty_1}{\ty_2}} &::=& 
        1 + \tymsrdflt{\ty_1} + \tymsrdflt{\ty_2}\\
    \\
    \hline
    \multicolumn{3}{c}{\tymsrdflt{\rexvar}} \\ 
    \hline 
    \tymsrdflt{\rexvarbound{\ty}{\ty}} &::=& \tymsrdflt{\ty}\\
    \tymsrdflt{\rexvarbound{\tylb}{\tyub}} &::=& 
        2\times(1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub})\\
    \\
    \hline
    \multicolumn{3}{c}{\tymsrdflt{\dctx}} \\ 
    \hline 
    \tymsrdflt{\square} &::=& 0\\
    \tymsrdflt{\typair{\dctx}{\ty}} &::=& 
        1 + \tymsrdflt{\dctx} + \tymsrdflt{\ty}\\
    \tymsrdflt{\typair{\ty}{\dctx}} &::=& 
        1 + \tymsrdflt{\ty} + \tymsrdflt{\dctx}\\
    \\
    \hline
    \multicolumn{3}{c}{\tymsrdflt{\tysig}} \\ 
    \hline 
    \tymsrdflt{\tyany} &::=& 1\\
    \multicolumn{3}{l}{\ldots} \\
    \tymsrdflt{\tyexist{\vany}{\tylb}{\tyub}{\tysig}} &::=& 
        1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub} + 
        \tymsr{\AEnv,\varbound{\vany}{\tylb}{\tyub}}{\tysig}\\
    \\
    \hline
    \multicolumn{3}{c}{\tymsrdflt{\dctxsig}} \\ 
    \hline 
    \tymsrdflt{\square} &::=& 0\\
    \tymsrdflt{\typair{\dctxsig}{\tysig}} &::=& 
        1 + \tymsrdflt{\dctxsig} + \tymsrdflt{\tysig}\\
    \tymsrdflt{\typair{\tysig}{\dctxsig}} &::=& 
        1 + \tymsrdflt{\tysig} + \tymsrdflt{\dctxsig}\\
\end{array}
\]
\caption{Measure of types and type signatures}\label{fig:ty-measure}
\end{figure}

To show the decidability of the subtyping algorithm,
we will use the measure $\msrop$ of types and type signatures,
as defined in \figref{fig:ty-measure}.
The measure function is defined recursively and is
similar to the syntactic size,
except for the treatment of type variables: for variables from~\AEnv,
the measure of a variable includes the measures of its bounds.
The definition of the measure for restricted existential variables \rexvar
reflects the fact that \tyinv\iname{\rexvar_1,\ldots,\rexvar_n} represents both
invariant constructors and restricted existential types.
When $\rexvar_i$ represents a single type $\ty_i$,
i.e. $\rexvar_i = \rexvarbound{\ty_i}{\ty_i}$,
its measure is simply the measure of the type $\ty_i$ in
\tyinv\iname{\ldots,\ty_i,\ldots}.
Otherwise, $\rexvar_i = \rexvarbound{\tylb_i}{\tyub_i}$ represents
an existential type with a single occurrence of the bound variable,
\tyexist{\vany_i}{\tylb_i}{\tyub_i}{\tyinv\iname{\ldots,\vany_i,\ldots}},
and measures accordingly, comprising both the binding and its single occurrence.

Note that the measure function itself always terminates and evaluates to a
positive integer. This is the case because for every recursive call
\tymsr{\AEnv'}{\ty'} of \tymsrdflt{\ty}, 
the combined syntactic size of the arguments $\size{\ty'} + \size{\AEnv'}$
is strictly smaller than $\size{\ty} + \size{\AEnv}$.
The same is true for recursive calls
\tymsr{\AEnv'}{\tysig'} of \tymsrdflt{\tysig}.
The syntactic size is defined in~\figref{fig:ty-size}.

\begin{figure}
\footnotesize
\[
\begin{array}{lcl}
    \hline
    \multicolumn{3}{c}{\size{\ty}} \\ 
    \hline 
    \size{\tyany} &::=& 1\\
    \size{\tybot} &::=& 1\\
    \size{\vany}  &::=& 1\\
    \size{\typair{\ty_1}{\ty_2}}  &::=& 1 + \size{\ty_1} + \size{\ty_2}\\
    \size{\tyinv\iname{\rexvar_1,\ldots,\rexvar_n}} &::=&
        1 + \size{\rexvar_1} + \ldots + \size{\rexvar_n}\\
    \size{\tyunion{\ty_1}{\ty_2}} &::=& 1 + \size{\ty_1} + \size{\ty_2}\\
    \\
    \hline
    \multicolumn{3}{c}{\size{\rexvar}} \\ 
    \hline 
    \size{\rexvarbound{\tylb}{\tyub}} &::=& \size{\tylb} + \size{\tyub}\\
    \\
    \hline
    \multicolumn{3}{c}{\size{\dctx}} \\ 
    \hline 
    \size{\square} &::=& 0\\
    \size{\typair{\dctx}{\ty}} &::=& 
        1 + \size{\dctx} + \size{\ty}\\
    \size{\typair{\ty}{\dctx}} &::=& 
        1 + \size{\ty} + \size{\dctx}\\
    \\
    \hline
    \multicolumn{3}{c}{\size{\tysig}} \\ 
    \hline 
    \size{\tyany} &::=& 1\\
    \multicolumn{3}{l}{\ldots} \\
    \size{\tyexist{\vany}{\tylb}{\tyub}{\tysig}} &::=& 
        1 + \size{\tylb} + \size{\tyub} + \size{\tysig}\\
    \\
    \hline
    \multicolumn{3}{c}{\size{\AEnv}} \\ 
    \hline 
    \size{\EmptyEnv} &::=& 0 \\
    \size{\AEnv, \varbound{\vany}{\tylb}{\tyub}} &::=& 
        \size{\AEnv} + \size{\tylb} + \size{\tyub}\\
    \\
    \hline
    \multicolumn{3}{c}{\size{\dctxsig}} \\ 
    \hline 
    \size{\square} &::=& 0\\
    \size{\typair{\dctxsig}{\tysig}} &::=& 
        1 + \size{\dctxsig} + \size{\tysig}\\
    \size{\typair{\tysig}{\dctxsig}} &::=& 
        1 + \size{\tysig} + \size{\dctxsig}\\
\end{array}
\]
\caption{Syntactic size}\label{fig:ty-size}
\end{figure}

In what follows, we will implicitly use the following facts about
distributivity contexts (proofs are straightforward by induction):
\begin{itemize}
    \item $\plug{\dctx}{\ty} = \ty';$
    \item $\plug{\dctx}{\dctx'} = \dctx'';$
    \item $\plug{\dctx}{\plug{\dctx'}{\ty}} = 
        \plug{(\plug{\dctx}{\dctx'})}{\ty};$
    \item $\subtydflt{\dctx}{\dctx'} \land \subtydflt{\ty}{\ty'}
        \implies \subtydflt{\plug{\dctx}{\ty}}{\plug{\dctx'}{\ty'}};$
    \item $\size{\plug{\dctx}{\ty}} = \size{\dctx} + \size{\ty};$
    \item $\tymsrdflt{\plug{\dctx}{\ty}} = \tymsrdflt{\dctx} + \tymsrdflt{\ty};$
    \item $\tymsrdflt{\plug{\dctxsig}{\tysig}} = 
        \tymsrdflt{\dctxsig} + \tymsrdflt{\tysig};$
    \item $\substvars(\plug\dctx\ty) = 
        \plug{\substvars(\dctx)}{\substvars(\ty)}; $    
    \item \TODO{more as needed}
\end{itemize}


\begin{theorem}{Termination of\ \ \subtydflt{\ty}{\ty'}.}%
\label{thm:subty-terminates}
    The subtyping algorithm built from the rules of subtyping of types
    \subtydflt{\ty}{\ty'} terminates.
\end{theorem}
\begin{proof}
    It follows from the fact that for each subtyping rule, 
    the measure of each premise \subtydflt{\ty_p}{\ty'_p}
    is strictly smaller than the measure 
    of the conclusion \subtydflt{\ty}{\ty'}, i.e.
    \[\tymsrdflt{\ty_p} + \tymsrdflt{\ty'_p} \quad<\quad 
    \tymsrdflt{\ty} + \tymsrdflt{\ty'}.\]

    For example, in the case \RST{VarLeft},
    \[\tymsrdflt{\plug\dctx\tyub} + \tymsrdflt{\ty'} < 
    \tymsrdflt{\plug\dctx\vany} + \tymsrdflt{\ty'}\]
    because \[\tymsrdflt{\tyub} < \tymsrdflt{\vany} = 
        1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub}.\]
\end{proof}

\begin{theorem}{Termination of\ \ \subtyctrdflt{\ty}{\ty'}.}%
\label{thm:subtyctr-terminates}
    The subtyping algorithm built from the rules of
    constrained subtyping of types
    \subtyctrdflt{\ty}{\ty'} terminates.
\end{theorem}
\begin{proof}
    Similarly to the previous theorem, the measure decreases, i.e.
    \[\tymsrdflt{\ty_p} + \tymsrdflt{\ty'_p} \quad<\quad 
    \tymsrdflt{\ty} + \tymsrdflt{\ty'}\]
    for each premise \subtyctrdflt{\ty_p}{\ty'_p}
    of the conclusion \subtyctrdflt{\ty}{\ty'}.
    
    The only interesting case is \RSC{U-UnionRight}.
    By the variable names convention~\ref{def:var-names}, $\va \notin \AEnv$.
    Therefore, $\tymsrdflt{\va} = \tymsrdflt{\va_1} = \tymsrdflt{\va_2}$.
\end{proof}

\begin{theorem}{Termination of\ \solvectrdflt.}%
\label{thm:solvectr-terminates}
    The constraints resolution algorithm \solvectrdflt terminates.
\end{theorem}
\begin{proof}
    It follows from the fact that:
    \begin{enumerate}
        \item subtyping algorithms \subtydflt{\ty}{\ty'} and 
            \subtyctrdflt{\ty}{\ty'} used to check the consistency of 
            constraints terminate;
        \item the argument \UEnv of the only recursive call to $\solvectrop$
            is strictly smaller than that of the original call.
    \end{enumerate} 
\end{proof}


\begin{figure}
\footnotesize
\[
\begin{array}{lcl}
    \hline
    \multicolumn{3}{c}{\occdflt{\ty}} \\ 
    \hline 
    \occdflt{\tyany} &::=& \false\\
    \occdflt{\tybot} &::=& \false\\
    \occdflt{\vany}  &::=& \true\\
    \occdflt{\vany'}  &::=& \false\\
    \occdflt{\typair{\ty_1}{\ty_2}}  &::=& \occdflt{\ty_1} \lor \occdflt{\ty_2}\\
    \occdflt{\tyinv\iname{\rexvar_1,\ldots,\rexvar_n}} &::=&
        \occdflt{\rexvar_1} \lor \ldots \lor \occdflt{\rexvar_n}\\
    \occdflt{\tyunion{\ty_1}{\ty_2}} &::=& \occdflt{\ty_1} \lor \occdflt{\ty_2}\\
    \\
    \hline
    \multicolumn{3}{c}{\occdflt{\rexvar}} \\ 
    \hline 
    \occdflt{\rexvarbound{\tylb}{\tyub}} &::=& \occdflt{\tylb} \lor \occdflt{\tyub}\\
    \\
    \hline
    \multicolumn{3}{c}{\occdflt{\tysig}} \\ 
    \hline 
    \occdflt{\tyany} &::=& \false\\
    \multicolumn{3}{l}{\ldots} \\
    \occdflt{\tyexist{\vany}{\tylb}{\tyub}{\tysig}} &::=& \true\\
    \occdflt{\tyexist{\vany'}{\tylb}{\tyub}{\tysig}} &::=& 
        \occdflt{\tylb} \lor \occdflt{\tyub} \lor \occdflt{\tysig}\\
    \\
    \hline
    \multicolumn{3}{c}{\occdflt{\AEnv}} \\ 
    \hline 
    \occdflt{\EmptyEnv} &::=& \false \\
    \occdflt{\AEnv, \varbound{\vany}{\tylb}{\tyub}} &::=& \true\\
    \occdflt{\AEnv, \varbound{\vany'}{\tylb}{\tyub}} &::=& 
        \occdflt{\AEnv} \lor \occdflt{\tylb} \lor \occdflt{\tyub}\\
\end{array}
\]
\caption{Occurrence of a variable}\label{fig:var-occ}
\end{figure}

\begin{lemma}{Context weakening in $\msrop$.}%
\label{lem:msr-weakening}
    The measure of a type signature does not change if the environment
    is extended (in any position) with a variable that occurs neither
    in the signature nor in the environment, i.e.,
    $\forall \tysig, \AEnv, \AEnv'. 
    \forall \varbound{\vany}{\tylb}{\tyub} \text{ s.t. } 
    \lnot \occdflt{\tysig} \land 
    \lnot \occdflt{\AEnv} \land \lnot \occdflt{\AEnv'}.$
    \[\tymsr{\concat{\AEnv}{\AEnv'}}{\tysig} = 
        \tymsr{\concat{\AEnv,\varbound{\vany}{\tylb}{\tyub}}{\AEnv'}}{\tysig},\]
    where \concat{\AEnv}{\AEnv''} denotes the concatenation of lists,
    and $\occop$ is defined in~\figref{fig:var-occ}.
\end{lemma}
\begin{proof}
    By strong induction on $n = \size{\AEnv} + \size{\AEnv'} + \size{\tysig}$.

    Case $n = 0$ is not possible, as the minimal size of a type signature is 1.
    
    In the inductive step for $n$, the induction hypothesis (IH) states that
    $\forall n'<n. \forall \tysig', \AEnv'', \AEnv'''  \text{ s.t. }
    n' = \size{\AEnv''} + \size{\AEnv'''} + \size{\tysig'}.
    \forall \varbound{\vany}{\tylb}{\tyub} \text{ s.t. } 
    \lnot \occdflt{\tysig'} \land 
    \lnot \occdflt{\AEnv''} \land \lnot \occdflt{\AEnv'''}.$
    \[\tymsr{\concat{\AEnv''}{\AEnv'''}}{\tysig'} = 
    \tymsr{\concat{\AEnv'',\varbound{\vany}{\tylb}{\tyub}}{\AEnv'''}}{\tysig'}.\]
    
    Case analysis on \tysig. Base cases \tyany and \tybot are straightforward.
    Cases $\times$, \tyinv\iname{\ldots}, and $\cup$ are also straightforward
    using the induction hypothesis for components of \tysig.
    The remaining cases are:
    \begin{itemize}
        \item Case $\vany'$. Case analysis on $\AEnv'$.
            \begin{itemize}
                \item Case \EmptyEnv. Because $\lnot \occdflt{\vany'},$ we know
                    $\vany \neq \vany'$. Thus,
                    $\tymsr{\AEnv, \varbound{\vany}{\tylb'}{\tyub'}}{\vany'} =
                    \tymsr{\AEnv}{\vany'}$ by definition of $\msrop$.
                \item Case $\AEnv', \varbound{\vany'}{\tylb'}{\tyub'}$.
                    By definition,
                    \[\tymsr{\concat{\AEnv}{\AEnv', \varbound{\vany'}{\tylb'}{\tyub'}}}{\vany'} =
                    1 + \tymsr{\concat{\AEnv}{\AEnv'}}{\tylb'} + 
                    \tymsr{\concat{\AEnv}{\AEnv'}}{\tyub'}.\]
                    Since $\size{\AEnv} + \size{\AEnv'} + \size{\tylb'}\ <\ 
                    \size{\AEnv} + \size{\AEnv', \varbound{\vany'}{\tylb'}{\tyub'}} + \size{\vany'} =
                    \size{\AEnv} + \size{\AEnv'} + \size{\tylb'} + \size{\tyub'} + 1$,
                    the IH applies with $\AEnv'' = \AEnv, \AEnv''' = \AEnv', 
                    \tysig' = \tylb'$, which gives 
                    $\tymsr{\concat{\AEnv}{\AEnv'}}{\tylb'} = 
                    \tymsr{\concat{\AEnv, \varbound{\vany}{\tylb}{\tyub}}{\AEnv'}}{\tylb'}$,
                    and similarly for $\tyub'$. Thus,
                    \[ \tymsr{\concat{\AEnv}{\AEnv', \varbound{\vany'}{\tylb'}{\tyub'}}}{\vany'} =
                    \tymsr{\concat{\AEnv, \varbound{\vany}{\tylb}{\tyub}}{\AEnv', \varbound{\vany'}{\tylb'}{\tyub'}}}{\vany'}. \]
            \end{itemize}
        \item Case \tyexist{\vany'}{\tylb'}{\tyub'}{\tysig}.
            By definition,
            \[\tymsr{\concat{\AEnv}{\AEnv'}}{\tyexist{\vany'}{\tylb'}{\tyub'}{\tysig}} =
            1 + \tymsr{\concat{\AEnv}{\AEnv'}}{\tylb'} + \msrop(\ldots\tyub') +
            \tymsr{\concat{\AEnv}{\AEnv', \varbound{\vany'}{\tylb'}{\tyub'}}}{\tysig}.\]
            Similarly to the last subcase of the $\vany'$ case, the IH applies
            to $\tylb'$ and $\tyub'$.
            Furthermore, since $\size{\AEnv} + \size{\AEnv'} + 
            \size{\tylb'} + \size{\tyub'} + \size{\tysig} <
            \size{\AEnv} + \size{\AEnv'} + 1 + \size{\tylb'} + \size{\tyub'}
            + \size{\tysig},$
            the IH applies to \tysig with $\AEnv'' = \AEnv, 
            \AEnv''' = (\AEnv', \varbound{\vany'}{\tylb'}{\tyub'}), 
            \tysig' = \tysig$.
            All pieces combined, 
            \[\tymsr{\concat{\AEnv}{\AEnv'}}{\tyexist{\vany'}{\tylb'}{\tyub'}{\tysig}} =
            \tymsr{\concat{\AEnv, \varbound{\vany}{\tylb}{\tyub}}{\AEnv'}}{\tyexist{\vany'}{\tylb'}{\tyub'}{\tysig}}.\]
            % and
            % \[\tymsr{\concat{\AEnv, \varbound{\vany}{\tylb}{\tyub}}{\AEnv'}}{\tyexist{\vany'}{\tylb'}{\tyub'}{\tysig}} =
            % 1 + \tymsr{\concat{\AEnv, \varbound{\vany}{\tylb}{\tyub}}{\AEnv'}}{\tylb'} + 
            % \tymsr{\concat{\AEnv, \varbound{\vany}{\tylb}{\tyub}}{\AEnv'}}{\tyub'} +
            % \tymsr{\concat{\AEnv, \varbound{\vany}{\tylb}{\tyub}}{\AEnv', \varbound{\vany'}{\tylb'}{\tyub'}}}{\tysig}.\]
    \end{itemize}
\end{proof}

\begin{theorem}{Termination of\ \ \subtysigdflt{\tysig}{\tysig'}.}%
\label{thm:subtysig-terminates}
    The subtyping algorithm built from the rules of
    subtyping of type signatures
    \subtysigdflt{\tysig}{\tysig'} terminates.
\end{theorem}
\begin{proof}
    It follows from the fact that for each subtyping rule, 
    the measure of each premise \subtysigdflt{\tysig_p}{\tysig'_p}
    is strictly smaller than the measure 
    of the conclusion \subtysigdflt{\tysig}{\tysig'}, i.e.
    \[\tymsr{\AEnv'}{\tysig_p} + \tymsr{\concat{\AEnv'}{\UEnv'}}{\tysig'_p} \quad<\quad 
    \tymsr{\AEnv}{\tysig} + \tymsr{\concat{\AEnv}{\UEnv}}{\tysig'}.\]

    Most of the cases are similar to the cases of~\thmref{thm:subty-terminates}
    on the termination of \subtydflt{\ty}{\ty'}.
    The remaining cases are:
    \begin{itemize}
        \item \RSS{InvLeft}. Since \vx is a fresh variable,
            by~\lemref{lem:msr-weakening} (weakening),
            $\tymsr{\AEnv, \varbound{\vx}{\tylb}{\tyub}}
                {\plug\dctxsig{\tyinv\iname{\ldots}}} = 
            \tymsrdflt{\plug\dctxsig{\tyinv\iname{\ldots}}},$ and also
            $\tymsr{\concat{\AEnv, \varbound{\vx}{\tylb}{\tyub}}{\UEnv}}{\tysig'}
            = \tymsr{\concat{\AEnv}{\UEnv}}{\tysig'}.$

            By the definition of $\msrop$,
            \[\tymsr{\AEnv, \varbound{\vx}{\tylb}{\tyub}}{\vx} =
            1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub} <
            2\times(1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub}) =
            \tymsrdflt{\rexvarbound{\tylb}{\tyub}},\]
            which concludes the case.
        \item \RSS{ExistLeft}. By the variables names
            convention~\defref{def:var-names}, \vx is different from variables
            in \AEnv, \UEnv, as well as bound variables of \dctxsig, \tysig,
            and $\tysig'$. Therefore, by~\lemref{lem:msr-weakening} (weakening),
            $\tymsr{\AEnv, \varbound{\vx}{\tylb}{\tyub}}{\dctxsig} = 
            \tymsrdflt{\dctxsig}$, and similarly for $\tysig'$.
            By the definition of $\msrop$,
            \[\tymsrdflt{\tyexist{\vx}{\tylb}{\tyub}{\tysig}} = 1 +
                \tymsrdflt{\tylb} + \tymsrdflt{\tyub} + 
                \tymsr{\AEnv, \varbound{\vx}{\tylb}{\tyub}}{\tysig},\]
            which is strictly larger than
            \tymsr{\AEnv, \varbound{\vx}{\tylb}{\tyub}}{\tysig} in the premise,
            which concludes the case.
        \item \RSS{ExistRight}. Similarly to \RSS{ExistLeft}.
        \item \RSS{Types}. The first premise,
            \subtyctrR{\AEnv}{\dom\UEnv}{\ty}{\ty'}{\CSet},
            terminates by \thmref{thm:subtyctr-terminates}.
            Since the constraints resolution \solvectrdflt terminates
            by \thmref{thm:solvectr-terminates}, the entire step also terminates.
    \end{itemize}
\end{proof}


\subsection{Properties of Subtyping of Types}%
\label{subsec:props-subty-proof}
%% ======================================================================

%We will use an implicit assumption that all types are valid
%in the given context.

\begin{theorem}{Reflexivity of subtyping of types.}\label{thm:sub-ty-refl}
    $
        \forall \ty, \AEnv, \text{ s.t. } \tyvlddflt{\ty}.\quad
        \subtydflt{\ty}{\ty}.
    $
\end{theorem}
\begin{proof}
    By induction on the structure of \ty.
    \begin{itemize}
        \item Case \tyany by \RST{Top}.
        \item Case \tybot by \RST{Bot}.
        \item Case \vany by \RST{VarRefl}.
        \item Case \typair{\ty_1}{\ty_2} by IH and \RST{Tuple}.
        \item Case \tyinv\iname{\rexvar_1,\ldots,\rexvar_n} by IH on
            $\tylb_i, \tyub_i$, and \RST{Inv}.
        \item Case \tyunion{\ty_1}{\ty_2} by IH, \RST{UnionRight},
            and \RST{UnionLeft}.
    \end{itemize}
\end{proof}

\begin{lemma}{Subtyping of \tybot implies arbitrary subtyping.}\label{lem:sub-of-bot}
    \[
    \forall \ty, \dctx_{\tybot}, \AEnv.\quad 
    \subtydflt{\ty}{\plug{\dctx_{\tybot}}\tybot}
    \quad\implies\quad
    (\forall \ty', \dctx'.\quad \subtydflt{\plug{\dctx'}{\ty}}{\ty'}).
    \]
\end{lemma}
\begin{proof}
    By induction on the derivation of 
    \subtydflt{\ty}{\plug{\dctx_{\tybot}}\tybot}.
    \begin{itemize}
        \item Case \RST{Bot}
            \subtydflt{\plug\dctx\tybot}{\plug{\dctx_{\tybot}}{\tybot}}
            where $\ty = \plug\dctx\tybot$.

            The case concludes by \RST{Bot}:
            \subtydflt{\plug{\dctx'}{\plug\dctx\tybot}}{\ty'}. 
        \item Case \RST{VarLeft}
            \subtydflt{\plug\dctx\vany}{\plug{\dctx_{\tybot}}{\tybot}}.

            By inversion, \subtydflt{\plug\dctx\tyub}{\plug{\dctx_{\tybot}}{\tybot}}.
            By IH, \subtydflt{\plug{\dctx'}{\plug\dctx\tyub}}{\ty'}.
            Thus, the case concludes by \RST{VarLeft}: 
            \subtydflt{\plug{\dctx'}{\plug\dctx\vany}}{\ty'}.
        \item Case \RST{Tuple}, subcase where
            $\dctx_{\tybot} = \typair{\dctx'_{\tybot}}{\ty'_2}$
            ($\dctx_{\tybot} = \square$ is not possible, and
            $\dctx_{\tybot} = \typair{\ty_1}{\dctx'_{\tybot}}$
            is proved analogously),
            $\ty = \typair{\ty_1}{\ty_2}$:
            \subtydflt{\typair{\ty_1}{\ty_2}}
            {\typair{\plug{\dctx'_{\tybot}}{\tybot}}{\ty'_2}}.

            By inversion, \subtydflt{\ty_1}{\plug{\dctx'_{\tybot}}{\tybot}}.
            By IH, \subtydflt{\plug{\dctx'^h}{\ty_1}}{\ty'} for all $\dctx'^h$,
            so we can take it to be \plug{\dctx'}{\typair{\square}{\ty_2}}.
            Thus, the case concludes by IH: 
            \subtydflt{\plug{\dctx'}{\typair{\ty_1}{\ty_2}}}{\ty'}.
        \item Case \RST{UnionLeft}
            \subtydflt{\plug\dctx{\tyunion{\ty_1}{\ty_2}}}{\plug{\dctx_{\tybot}}{\tybot}}
            where $\ty = \tyunion{\ty_1}{\ty_2}$.
            By inversion, 
            \subtydflt{\plug\dctx{\ty_1}}{\plug{\dctx_{\tybot}}{\tybot}} and
            \subtydflt{\plug\dctx{\ty_2}}{\plug{\dctx_{\tybot}}{\tybot}}.
            By IH, \subtydflt{\plug{\dctx'}{\plug\dctx{\ty_1}}}{\ty'} and
            \subtydflt{\plug{\dctx'}{\plug\dctx{\ty_2}}}{\ty'}.
            Thus, the case concludes by \RST{UnionLeft}: 
            \subtydflt{\plug{\dctx'}{\plug\dctx{\tyunion{\ty_1}{\ty_2}}}}{\ty'}.
    \end{itemize}
    The remaining cases 
    (\RST{Top}, \RST{VarRefl}, \RST{VarRight}, \RST{Inv}, \RST{UnionRight}) 
    are not possible.
\end{proof}

\begin{lemma}{Subtyping of inner union on the right.}%
\label{lem:sub-inner-union-right}
    $\forall \ty, \dctx', \ty'_1, \ty'_2, \AEnv, \text{ s.t. }
    \tyvlddflt{\ty, \dctx', \ty'_1, \ty'_2}.$
    \[
        \begin{array}{ccc}
        \subtydflt{\ty}{\plug{\dctx'}{\tyunion{\ty'_1}{\ty'_2}}}\\
        \quad\implies\quad\\
        (\forall \dctx_1, \dctx_2, \text{ s.t. }
        \tyvlddflt{\dctx_1, \dctx_2} \land
        \subtydflt{\dctx_1}{\dctx_2}.\quad
        \subtydflt
            {\plug{\dctx_1}{\ty}}
            {\tyunion
                {\plug{\dctx_2}{\plug{\dctx'}{\ty'_1}}}
                {\plug{\dctx_2}{\plug{\dctx'}{\ty'_2}}}
            }).
        \end{array}
    \]
\end{lemma}
\begin{proof}
    By induction on the derivation of
    \subtydflt{\ty}{\plug{\dctx'}{\tyunion{\ty'_1}{\ty'_2}}}.
    \begin{itemize}
        \item Case \RST{Bot} by \RST{Bot}.
        \item Case \RST{VarLeft} by inversion, IH, and \RST{VarLeft}.
        \item Case \RST{Tuple}, subcase where
            $\dctx' = \typair{\dctx''}{\ty'}$:
            \subtydflt{\typair{\ty_1}{\ty_2}}
                {\typair{\plug{\dctx''}{\tyunion{\ty'_1}{\ty'_2}}}{\ty'}}.
            By inversion,
            \subtydflt{\ty_1}{\plug{\dctx''}{\tyunion{\ty'_1}{\ty'_2}}} and
            \subtydflt{\ty_2}{\ty'}. 
            
            By IH applied to 
            \subtydflt{\ty_1}{\plug{\dctx''}{\tyunion{\ty'_1}{\ty'_2}}},
            \subtydflt{\plug{\dctx^h_1}{\ty_1}}
                {\tyunion
                    {\plug{\dctx^h_2}{\plug{\dctx''}{\ty'_1}}}
                    {\plug{\dctx^h_2}{\plug{\dctx''}{\ty'_2}}}
                }
            for all $\dctx^h_1, \dctx^h_2$ s.t. $\subtydflt{\dctx^h_1}{\dctx^h_2}$.
            Thus, we can take them to be \plug{\dctx_2}{\typair{\square}{\ty_2}} 
            and \plug{\dctx_2}{\typair{\square}{\ty'}}, 
            respectively, which concludes the case with
            \subtydflt{\plug{\dctx_1}{\typair{\ty_1}{\ty_2}}}
                {\tyunion
                    {\plug{\dctx_2}{\typair{\plug{\dctx''}{\ty'_1}}{\ty_2}}}
                    {\plug{\dctx_2}{\typair{\plug{\dctx''}{\ty'_2}}{\ty'}}}
                }
        \item Case \RST{UnionLeft} by inversion, IH, and \RST{UnionLeft}.
        \item Case \RST{UnionRight}, subcase $i = 1$ where $\dctx' = \square$:
            \subtydflt{\ty}{\tyunion{\ty'_1}{\ty'_2}}.
            By inversion, \subtydflt\ty{\ty'_1}.
            By assumption, \subtydflt{\dctx_1}{\dctx_2}, and thus,
            \subtydflt{\plug{\dctx_1}{\ty}}{\plug{\dctx_2}{\ty'_1}}.
            The case concludes by \RST{UnionRight} with $i=1$:
            \subtydflt{\plug{\dctx_1}{\ty}}
                {\tyunion{\plug{\dctx_2}{\ty'_1}}{\plug{\dctx_2}{\ty'_2}}}.
    \end{itemize}
    The remaining cases 
    (\RST{Top}, \RST{VarRefl}, \RST{VarRight}, \RST{Inv}) 
    are not possible.
\end{proof}

\begin{lemma}{Adding inner union on the right.}%
\label{lem:add-inner-union-right}
    $\forall \ty, \dctx', \ty', \AEnv, \text{ s.t. }
    \tyvlddflt{\ty, \dctx', \ty'}.$
    \[
        \subtydflt{\ty}{\plug{\dctx'}{\ty'}}
        \quad\implies\quad
        (\forall \ty''.\ \subtydflt{\ty}{\plug{\dctx'}{\tyunion{\ty'}{\ty''}}}).
    \]
\end{lemma}
\begin{proof}
    By induction on the derivation of
    \subtydflt{\ty}{\plug{\dctx'}{\ty'}}.
    \begin{itemize}
        \item Case \RST{Top} where $\dctx'=\square$. By assumption
            \subtydflt{\ty}{\tyany} and \RST{UnionRight} with $i=1$,
            \subtydflt{\ty}{\tyunion{\tyany}{\ty''}}.
        \item Case \RST{Bot} by \RST{Bot}.
        \item Case \RST{VarRefl} where $\dctx'=\square$
            by assumption and \RST{UnionRight} with $i=1$.
        \item Case \RST{VarLeft} by inversion, IH, and \RST{VarLeft}.
        \item Case \RST{VarRight} where $\dctx'=\square$
            by assumption and \RST{UnionRight} with $i=1$.
        \item Case \RST{Tuple}. 
            Subcase $\dctx'$ by assumption and \RST{UnionRight} with $i=1$.
            The other two subcases by inversion, IH, and \RST{Tuple}.
        \item Case \RST{Inv} where $\dctx'=\square$
            by assumption and \RST{UnionRight} with $i=1$.
        \item Case \RST{UnionLeft} by inversion, IH, and \RST{UnionLeft}.
        \item Case \RST{UnionRight} where $\dctx'=\square$
            by assumption and \RST{UnionRight} with $i=1$.
    \end{itemize}
\end{proof}

\begin{lemma}{Subtyping of union on the right.}%
\label{lem:sub-union-right}
    $\forall \ty, \dctx', \ty'_1, \ty'_2, \AEnv, \text{ s.t. }
    \tyvlddflt{\ty, \dctx', \ty'_1, \ty'_2}.$
    \[
        \subtydflt{\ty}{\tyunion{\plug{\dctx'}{\ty'_1}}{\plug{\dctx'}{\ty'_2}}}
        \quad\implies\quad
        \subtydflt{\ty}{\plug{\dctx'}{\tyunion{\ty'_1}{\ty'_2}}}.
    \]
\end{lemma}
\begin{proof}
    By induction on the derivation of
    \subtydflt{\ty}{\tyunion{\plug{\dctx'}{\ty'_1}}{\plug{\dctx'}{\ty'_2}}}.
    Four cases are possible: \RST{Bot}, \RST{VarLeft}, \RST{UnionLeft}, and
    \RST{UnionRight}. The first three are analogous to the cases of
    \lemref{lem:sub-inner-union-right} (subtyping inner union on the right): 
    inversion, IH, constructor.
    The remaining case is \RST{UnionRight}, subcase $i=1$.
    By inversion, \subtydflt{\ty}{\plug{\dctx'}{\ty'_1}}.
    Thus, the case concludes by \lemref{lem:add-inner-union-right} (adding inner
    union on the right):
    \subtydflt{\ty}{\plug{\dctx'}{\tyunion{\ty'_1}{\ty'_2}}}.
    % bot by bot
    % VarLeft by inversion, IH, VarLeft
    % UnionLeft by inversion, IH, UnionLeft
\end{proof}

\begin{lemma}{Context weakening in subtyping of types.}%
\label{lem:subty-weakening}
    $\forall \AEnv, \ty, \ty'.\ \forall \AEnv' \text{ s.t. }$\\
    $\dom{\AEnv'} \cap \dom{\AEnv} = \varnothing \land 
    (\forall \vany \in \dom{\AEnv'}. 
        \lnot \occ{\vany}{\ty} \land \lnot \occ{\vany}{\ty}),$
    \[ \subtydflt{\ty}{\ty'} \quad\implies\quad 
    \subty{\concat{\AEnv}{\AEnv'}}{\ty}{\ty'}. \]
\end{lemma}
\begin{proof}
    Straightforward induction on the derivation of \subtydflt{\ty}{\ty'}.
\end{proof}


\begin{theorem}{Transitivity of subtyping of types.}\label{thm:sub-ty-trans}
    $\forall \ty_1, \ty_2, \ty_3, \AEnv, \text{ s.t. }
    \tyvlddflt{\ty_1, \ty_2, \ty_3} \land \tyvld{\,}{\AEnv}.$
    \[
        \subtydflt{\ty_1}{\ty_2} \land \subtydflt{\ty_2}{\ty_3}
        \quad\implies\quad
        \subtydflt{\ty_1}{\ty_3}.
    \]
\end{theorem}
\begin{proof}
    By strong induction on
    $n = \tymsrdflt{\ty_1} + 2\times\tymsrdflt{\ty_2} + \tymsrdflt{\ty_3}$.
    Cases $n = 1..3$ are not possible as the minimal measure of a type is 1.
    In the inductive step for $n$, the induction hypothesis (IH) states that
    $\forall n'<n. \forall \ty'_1, \ty'_2, \ty'_3 \text{ s.t. }
    n' = \tymsrdflt{\ty'_1} + 2\times\tymsrdflt{\ty'_2} + \tymsrdflt{\ty'_3},$
    it holds that
    \[
        \subtydflt{\ty'_1}{\ty'_2} \land \subtydflt{\ty'_2}{\ty'_3}
        \quad\implies\quad
        \subtydflt{\ty'_1}{\ty'_3}.
    \]
    Case analysis on \subtydflt{\ty_2}{\ty_3} (the most interesting cases are
    highlighted in bold).
    \begin{itemize}
        \item Case \RST{Top} \subtydflt{\ty_2}{\tyany} where $\ty_3 = \tyany$
            concludes by \RST{Top}: \subtydflt{\ty_1}{\tyany}.
        \item Case \RSS{Bot} \subtydflt{\plug\dctx\tybot}{\ty_3}
            where $\ty_2=\plug\dctx\tybot$.
            The case concludes by \lemref{lem:sub-of-bot}
            (subtyping of \tybot) applied
            to the assumption \subtydflt{\ty_1}{\plug\dctx\tybot}
            with $\dctx' = \square, \ty' = \ty_3$:
            \subtydflt{\ty_1}{\ty_3}.
        \item Case \RST{VarRefl} \subtydflt{\vany}{\vany}.
            Since $\ty_2=\ty_3=\vany$, the case concludes by the assumption
            \subtydflt{\ty_1}{\vany}.
        \item \textbf{Case \RST{VarLeft}} \subtydflt{\plug\dctx\vany}{\ty_3} 
            where $\ty_2 = \plug\dctx\vany$.
            By inversion, $\varbound{\vany}{\tylb}{\tyub} \in \AEnv$ and
            \subtydflt{\plug\dctx{\tyub}}{\ty_3}.
            By assumption, \subtydflt{\ty_1}{\plug\dctx\vany}.
            We will need the following auxiliary fact.

            \begin{lemma}\label{lem:sub-var-right-sub-ub}
                \subtydflt{\ty_1}{\plug\dctx\tyub}.
            \end{lemma}
            \begin{proof}
                By induction on \subtydflt{\ty_1}{\plug\dctx\vany}.
                \begin{itemize}
                    \item Case \RST{Bot} by \RST{Bot}.
                    \item Case \RST{VarRefl} \subtydflt{\vany}{\vany}.
                        By \thmref{thm:sub-ty-refl} (reflexivity),
                        \subtydflt{\tyub}{\tyub}.
                        Thus, by \RST{VarLeft}, \subtydflt{\vany}{\tyub}.
                    \item Case \RST{VarLeft} 
                        \subtydflt{\plug{\dctx'}{\vany'}}{\plug\dctx\vany}.
                        By inversion, $\varbound{\vany'}{\tylb'}{\tyub'} \in \AEnv$
                        and \subtydflt{\plug{\dctx'}{\tyub'}}{\plug\dctx\vany}.
                        By IH,
                        \subtydflt{\plug{\dctx'}{\tyub'}}{\plug\dctx\tyub}.
                        Thus, by \RST{VarLeft},
                        \subtydflt{\plug{\dctx'}{\vany'}}{\plug\dctx\tyub}.
                    \item \textbf{Case \RST{VarRight}} \subtydflt{\ty_1}{\vany}.
                        By inversion, $\varbound{\vany}{\tylb}{\tyub} \in \AEnv$
                        and \subtydflt{\ty_1}{\tylb}.
                        By inversion of the assumptions \tyvlddflt{\vany} and
                        \tyvld{\,}{\AEnv} and by~\lemref{lem:subty-weakening}
                        (context weakening), we have \subtydflt{\tylb}{\tyub}.

                        Since $\ty_2 = \vany$ and $\tymsrdflt{\vany} = 
                        1 + \tymsrdflt{\tylb} + \tymsrdflt{\tyub}$, we have
                        $\tymsrdflt{\ty_1} + 2\times\tymsrdflt{\tylb} + 
                        \tymsrdflt{\tyub} < \tymsrdflt{\ty_1} + 
                        2\times\tymsrdflt{\vany} + \tymsrdflt{\ty_3}$. Thus,
                        IH for \emph{transitivity} is applicable to 
                        \subtydflt{\ty_1}{\tylb} and \subtydflt{\tylb}{\tyub},
                        which concludes the case with \subtydflt{\ty_1}{\tyub}.
                    \item Case \RST{Tuple}, subcase
                        $\dctx = \typair{\dctx'}{\ty_{22}}$
                        ($\dctx = \square$ is not possible, and
                        $\dctx = \typair{\ty_{21}}{\dctx'}$
                        is proved analogously), i.e.
                        \subtydflt
                            {\typair{\ty_{11}}{\ty_{12}}}
                            {\typair{\plug{\dctx'}\vany}{\ty_{22}}}.
                        By inversion, \subtydflt{\ty_{11}}{\plug{\dctx'}\vany}
                        and \subtydflt{\ty_{12}}{\ty_{22}}.
                        By IH, \subtydflt{\ty_{11}}{\plug{\dctx'}\tyub}.
                        Thus, by \RST{Tuple},
                        \subtydflt
                            {\typair{\ty_{11}}{\ty_{12}}}
                            {\typair{\plug{\dctx'}\tyub}{\ty_{22}}}.
                    \item Case \RST{UnionLeft} is proved analogously 
                        to \RST{Tuple}: by inversion, IH, and \RST{UnionLeft}.
                \end{itemize}
                The remaining cases
                (\RST{Top}, \RST{Tuple}, \RST{Inv}, \RST{UnionRight}) 
                are not possible.
            \end{proof}

            Be \lemref{lem:sub-var-right-sub-ub} above,
            \subtydflt{\ty_1}{\plug\dctx\tyub}.
            Since $\ty_2 = \plug\dctx\vany$ and 
            $\tymsrdflt{\tyub} < \tymsrdflt{\vany}$,
            IH is applicable to \subtydflt{\ty_1}{\plug\dctx\tyub} and 
            \subtydflt{\plug\dctx\tyub}{\ty_3}, which concludes the case with
            \subtydflt{\ty_1}{\ty_3}.
        \item Case \RST{VarRight} \subtydflt{\ty_2}{\vany}.
            By inversion, $\varbound{\vany}{\tylb}{\tyub} \in \AEnv$ and
            \subtydflt{\ty_2}{\tylb}.
            Since $\tymsrdflt{\tylb} < \tymsrdflt{\vany}$, by IH,
            \subtydflt{\ty_1}{\tylb}.
            Thus, by \RST{VarRight}, \subtydflt{\ty_1}{\vany}.
        \item Case \RST{Tuple} 
            \subtydflt{\typair{\ty_{21}}{\ty_{22}}}{\typair{\ty_{31}}{\ty_{32}}}
            where $\ty_i = \typair{\ty_{i1}}{\ty_{i2}}$.
            Case analysis on \subtydflt{\ty_1}{\typair{\ty_{21}}{\ty_{22}}}.
            \begin{itemize}
                \item Case \RST{Bot} by \RST{Bot}.
                \item Case \RST{VarLeft} by inversion, IH on 
                    \subtydflt{\plug\dctx\tyub}{\ty_2} and
                    \subtydflt{\ty_2}{\ty_3}, and \RST{VarLeft} on
                    \subtydflt{\plug\dctx\tyub}{\ty_3}.
                \item Case \RST{Tuple} by inversion, IH on
                    \subtydflt{\ty_{1j}}{\ty_{2j}} and 
                    \subtydflt{\ty_{2j}}{\ty_{3j}}, and \RST{Tuple}.
                \item Case \RST{UnionLeft} 
                    \subtydflt{\plug\dctx{\tyunion{\ty_{11}}{\ty_{12}}}}{\ty_2}
                    by inversion, IH on
                    \subtydflt{\plug\dctx{\ty_{1j}}}{\ty_2} and
                    \subtydflt{\ty_2}{\ty_3}, and \RST{UnionLeft}.
            \end{itemize}
            The remaining cases
            (\RST{Top}, \RST{VarRefl}, \RST{VarRight}, \RST{Inv}, \RST{UnionRight}) 
            are not possible.
        \item Case \RST{Inv} is proved similarly to \RST{Tuple}, with
            possible cases of \subtydflt{\ty_1}{\ty_2} being
            \RST{Bot}, \RST{VarLeft}, \RST{Inv}, and \RST{UnionLeft}.
        \item \textbf{Case \RST{UnionLeft}} 
            \subtydflt{\plug\dctx{\tyunion{\ty_{21}}{\ty_{22}}}}{\ty_3}.
            By \lemref{lem:sub-inner-union-right} applied to
            \subtydflt{\ty_1}{\plug\dctx{\tyunion{\ty_{21}}{\ty_{22}}}}
            with $\dctx_1=\square,\dctx_2=\square$,
            \subtydflt{\ty_1}{\tyunion{\plug\dctx{\ty_{21}}}{\plug\dctx{\ty_{22}}}}.
            Case analysis on the latter.
            \begin{itemize}
                \item Case \RST{Bot} by \RST{Bot}.
                \item Case \RST{VarLeft} where $\ty_1 = \plug{\dctx'}\vany$.
                    By inversion, $\varbound{\vany}{\tylb}{\tyub} \in \AEnv$ and
                    \subtydflt{\plug{\dctx'}\tyub}
                    {\tyunion{\plug\dctx{\ty_{21}}}{\plug\dctx{\ty_{22}}}}.
                    By \lemref{lem:sub-union-right} applied to the latter,
                    \subtydflt{\plug{\dctx'}\tyub}
                    {\plug\dctx{\tyunion{\ty_{21}}{\ty_{22}}}}.

                    Since $\tymsrdflt{\tyub} < \tymsrdflt{\vany}$, by IH,
                    \subtydflt{\plug{\dctx'}\tyub}{\ty_3}.
                    Thus, the case concludes by \RST{VarLeft}:
                    \subtydflt{\plug{\dctx'}\vany}{\ty_3}.
                \item Case \RST{UnionLeft} similarly to \RST{VarLeft}.
                \item Case \RST{UnionRight}, subcase $i=1$.
                    By inversion, \subtydflt{\ty_1}{\plug\dctx{\ty_{21}}}.
                    By inversion of the outer case assumption
                    \subtydflt{\plug\dctx{\tyunion{\ty_{21}}{\ty_{22}}}}{\ty_3},
                    \subtydflt{\plug\dctx{\ty_{21}}}{\ty_3}.
                    Since $\tymsrdflt{\plug\dctx{\ty_{21}}} < 
                    \tymsrdflt{\plug\dctx{\tyunion{\ty_{21}}{\ty_{22}}}}$,
                    by IH, \subtydflt{\ty_1}{\ty_3}.
            \end{itemize}
            The remaining cases
            (\RST{Top}, \RST{VarRefl}, \RST{VarRight}, \RST{Tuple}, \RST{Inv}) 
            are not possible.
        \item Case \RST{UnionRight} 
            \subtydflt{\ty_2}{\tyunion{\ty_{31}}{\ty_{32}}} where 
            $\ty_3 = \tyunion{\ty_{31}}{\ty_{32}}$, subcase $i=1$.
            By inversion, \subtydflt{\ty_2}{\ty_{31}}. Since
            $\tymsrdflt{\ty_{31}} < \tymsrdflt{\tyunion{\ty_{31}}{\ty_{32}}}$,
            by IH, \subtydflt{\ty_1}{\ty_{31}}.
            Thus, the case concludes by \RST{UnionRight}.
    \end{itemize}
\end{proof}

%% This fact we use implicitly
% \begin{lemma}{Preservation of subtyping by distributivity context.}%
%     \[
%         \forall \AEnv, \dctx, \ty, \ty'.\quad
%         \subtydflt{\ty}{\ty'} \quad\implies\quad
%         \subtydflt{\plug\dctx\ty}{\plug\dctx{\ty'}}.
%      \]
% \end{lemma}
% \begin{proof}
%     Straightforward by induction on the structure of \dctx,
%     using the assumption \subtydflt{\ty}{\ty'} in the base case
%     and \thmref{thm:sub-ty-refl} (reflexivity) in the inductive cases.
% \end{proof}

\begin{theorem}{Soundness of subtyping of types with respect to a subsitution.}%
\label{thm:subty-sound-subst}
    $\forall \AEnv, \ty, \ty' \text{ s.t. } \tyvlddflt{\ty, \ty'}.\ 
     \forall \AEnv', \substvars \text{ s.t. } \vldinenvdflt{\substvars}.$
     \[ 
        \subtydflt{\ty}{\ty'} \quad\implies\quad
        \subty{\AEnv'}{\substvars(\ty)}{\substvars(\ty')}.
     \]
\end{theorem}
\begin{proof}
    By induction on the derivation of \subtydflt{\ty}{\ty'}.

    Cases \RST{Top} and \RST{Bot} are straightforward by \RST{Top} and
    \RST{Bot}, respectively. 

    Case \RST{VarRefl} by \thmref{thm:sub-ty-refl} (reflexivity):
    \subty{\AEnv'}{\substvars(\vany)}{\substvars(\vany)}.

    Cases \RST{Tuple}, \RST{Inv}, \RST{UnionLeft}, and \RST{UnionRight} are
    straightforward using inversion, the inductive hypothesis, and constructor.
    For example, consider the case \RST{Tuple}
    \subtydflt{\typair{\ty_1}{\ty_2}}{\typair{\ty'_1}{\ty'_2}}.
    By inversion, \subtydflt{\ty_i}{\ty'_i}.
    By IH, \subty{\AEnv'}{\substvars(\ty_i)}{\substvars(\ty'_i)}.
    The case concludes by \RST{Tuple} with 
    \[\subty{\AEnv'}{\typair{\substvars(\ty_1)}{\substvars(\ty_2)}}
    {\typair{\substvars(\ty'_1)}{\substvars(\ty'_2)}}\]
    and the fact that $\substvars(\typair{\ty_1}{\ty_2}) = 
    \typair{\substvars(\ty_1)}{\substvars(\ty_2)}.$

    The remaining cases \RST{VarLeft} and \RST{VarRight} are similar.
    For example, consider \RST{VarLeft} \subtydflt{\plug{\dctx}\vany}{\ty'}.
    By inversion, $\varbound{\vany}{\tylb}{\tyub} \in \AEnv$ and
    \subtydflt{\plug\dctx{\tyub}}{\ty'}.
    By IH, \subty{\AEnv'}{\substvars(\plug\dctx{\tyub})}{\substvars(\ty')}.
    By inversion of the assumption \vldinenvdflt{\substvars}, we know
    \subty{\AEnv'}{\substvars(\vany)}{\substvars(\tyub)}.
    Since $\substvars(\plug\dctx{\tyub}) = 
    \plug{\substvars(\dctx)}{\substvars(\tyub)}$ and
    \subty{\AEnv'}{\substvars(\dctx)}{\substvars(\dctx)} by reflexivity,
    we have \subty{\AEnv'}{\plug{\substvars(\dctx)}{\substvars(\vany)}}
    {\plug{\substvars(\dctx)}{\substvars(\tyub)}}.
    The case concludes by \thmref{thm:sub-ty-trans} (transitivity) with the
    middle type $\substvars(\plug\dctx{\tyub})$:
    \[\subty{\AEnv'}{\substvars(\plug\dctx{\vany})}{\substvars(\ty')}.\]
\end{proof}
