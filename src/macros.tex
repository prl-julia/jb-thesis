%% General
%% ======================================================================

\newcommand{\TODO}[1]{\textcolor{red}{\textbf{TODO:} #1}}

\newcommand{\figref}[1]{Figure~\ref{#1}\xspace}
\newcommand{\tabref}[1]{Table~\ref{#1}\xspace}
\newcommand{\lemref}[1]{Lemma~\ref{#1}\xspace}
\newcommand{\thmref}[1]{Theorem~\ref{#1}\xspace}
\newcommand{\ruleref}[1]{Rule~{\small #1}\xspace}
\newcommand{\defref}[1]{Definition~\ref{#1}\xspace}
\newcommand{\secref}[1]{Section~\ref{#1}\xspace}
\newcommand{\chapref}[1]{Chapter~\ref{#1}\xspace}
\newcommand{\appref}[1]{Appendix~\ref{#1}\xspace}

\newcommand{\tdef}[1]{\textbf{#1}}

\newcommand{\CSharp}{C\texttt{\small\#}\xspace}
\newcommand{\FSub}{$F_{<:}$\xspace}
\newcommand{\FSubN}{$F^N_{\leq}$\xspace}
\newcommand{\DSub}{$D_{<:}$\xspace}
\newcommand{\WyvCore}{$Wyv_{core}$\xspace}
\newcommand{\WyvSelf}{$Wyv_{self}$\xspace}
\newcommand{\WyvFix}{$Wyv_{fix}$\xspace}
\newcommand{\FSubR}{$F^R_{<:}$\xspace}

%% for wide figures:
%% http://16marzo.blogspot.com/2009/09/figure-e-margini-in-classicthesis.html
\newlength\largefigure
\setlength{\largefigure}{\columnwidth+\marginparsep+\marginparwidth}

\definecolor{light-gray}{gray}{0.85}
\definecolor{jlbuiltin}{HTML}{397300}

\newcommand{\cfbox}[2]{%
    \colorlet{currentcolor}{.}%
    {\color{#1}%
    \fbox{\color{currentcolor}#2}}%
}

\newcommand{\ruleswidth}{16cm}

%% Code
%% *********************************************************

\newcommand{\code}[1]{\texttt{\small#1}\xspace}
\newcommand{\cjl}[1]{\lstinline[language=Julia]!#1!\xspace}

\lstnewenvironment{julia}
    {\lstset{language=Julia,numbers=left,}}
    {}
\newenvironment{codeenvd}
    {
    \begin{center}
    \begin{minipage}{10cm}
    }
    {
    \end{minipage}
    \end{center}
    }

%% Math
%% *********************************************************

%% make sure we are in math mode
\newcommand{\EM}[1]{\ensuremath{#1}\xspace}

\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}

\newcommand{\interp}[1]{\EM{\llbracket #1 \rrbracket}}

%% medium sized cup
\newcommand{\mcup}{\textstyle\bigcup}
\newcommand{\msqcap}{\textstyle\bigsqcap}

%% plugging
\newcommand{\plug}[2]{\EM{#1[#2]}}

%% substitution element
\newcommand{\substel}[2]{\EM{#1\!\mapsto\!#2}}
%% substitution
\newcommand{\subst}[2]{#1[#2]}
%% empty substitution
\newcommand{\emptysubst}{[]}

%% list concatenation
\DeclareMathOperator{\concatop}{+\!+}
\newcommand{\concat}[2]{\EM{#1\concatop#2}}

\newcommand{\ok}{\EM{\mathrm{ok}}}

\newcommand{\false}{\EM{\mathtt{false}}}
\newcommand{\true}{\EM{\mathtt{true}}}

\newcommand{\algo}{\ensuremath{\mathcal{A}}\xspace}

%% Formalization
%% ======================================================================

% inference rule name
\newcommand{\IRN}[2]{{\textsc{#1-#2}}\xspace}
% subtyping rules
\newcommand{\RST}[1]{\IRN{ST}{#1}} % subtyping types
\newcommand{\RSC}[1]{\IRN{SC}{#1}} % subtyping constraints
\newcommand{\RSS}[1]{\IRN{SS}{#1}} % subtyping signatures
% lambda-julia rules
\newcommand{\RLJ}[1]{{\textsc{#1}}\xspace}

%% Style
%% *********************************************************

\newcommand{\tyname}[1]{\EM{\mathsf{#1}}}   %% type name (like Int)
\newcommand{\var}[1]{\EM{\mathrm{#1}}}      %% variable (like V, X)

%% overline for list
\newcommand{\ol}[1]{\EM{\overline{#1}}}

%% constraint set
\newcommand{\ctrset}[1]{\EM{\{#1\}}}
%% constraint element
\newcommand{\ctrsub}[2]{\EM{#1 \leq #2}}
%% singleton constraint set
\newcommand{\ctrsngl}[2]{\ctrset{\ctrsub{#1}{#2}}}

% %% side condition
% \newcommand{\sidecond}[1]{\EM{\scriptstyle #1}}

% %% inference rule names
% \newcommand{\SR}[1]{\textsc{S-#1}}
% \newcommand{\ER}[1]{\textsc{E-#1}}

%% Metavariables
%% *********************************************************

\newcommand{\tysig}{\EM{\psi}}              %% type signature
\newcommand{\ty}{\EM{\tau}}                 %% type
\newcommand{\gty}{\EM{\sigma}}              %% (concrete) type tag
\newcommand{\sty}{\EM{\phi}}                %% simple type

\newcommand{\tylb}{\EM{l}}                   %% lower bound type
\newcommand{\tyub}{\EM{u}}                   %% upper bound type

\newcommand{\iname}{\EM{N}}                 %% invariant constructor
\newcommand{\cname}{\EM{C}}
\newcommand{\aname}{\EM{A}}

\newcommand{\rexvar}{\EM{v}}                %% restricted existential variable

\newcommand{\TyTable}{\EM{\mathcal{T}}}     %% type declarations
\newcommand{\tydecl}{\EM{\mathop{td}}}
\newcommand{\ubdecl}{\EM{\mathop{ud}}}

\newcommand{\dctx}{\EM{\delta}}             %% distributivity context
\newcommand{\dctxsig}{\EM{\zeta}}           
\newcommand{\dctxty}{\EM{\dctx}}
\newcommand{\dctxtysig}{\EM{\dctxsig}}
%\newcommand{\dctxty}{\EM{\dctx^\ty}}
%\newcommand{\dctxtysig}{\EM{\dctx^\tysig}}

\newcommand{\AEnv}{\EM{\Gamma}}             %% forall-variable environment
\newcommand{\UEnv}{\EM{\Delta}}             %% unification-variable environment
\newcommand{\UEnvD}{\EM{\mathrm{H}}}        %% unification-var env dom

\newcommand{\EmptyEnv}{\EM{\cdot}}

%\newcommand{\CSet}{\EM{\mathcal{C}}}       %% set of subtype constraints
\newcommand{\CSet}{\EM{\mathrm{K}}}         %% set of subtype constraints
\newcommand{\EmptyCSet}{\EM{\varnothing}}   %% empty set of constraints
%\newcommand{\EmptyCSet}{\ctrset{}}          %% empty set of constraints

\newcommand{\substvars}{\EM{\rho}}         %% substitution for constraints

%% Symbols
%% *********************************************************

\newcommand{\Alt}{~\vert~}                  %% |

%% Type Constructors
%% *********************************************************

\newcommand{\tyany}{\EM{\top}}
\newcommand{\tybot}{\EM{\bot}}

\newcommand{\typair}[2]{\EM{#1 \times #2}}  %% t1 × t2
\newcommand{\tyunion}[2]{\EM{#1 \cup #2}}   %% t1 ∪ t2

\newcommand{\tyinv}[2]{\EM{#1\{#2\}}}       %% t1{...}

%% type variable with both bounds
\newcommand{\varbound}[3]{\EM{#2{\symsub}#1{\symsub}#3}} %% tl<:X<:tu
%% restricted existential variable with both bounds
\newcommand{\rexvarbound}[2]{\EM{#1{\symrexvarsub}#2}} %% tl<<tu

%% regular existential type with all bounds ∃tX_lb^ub.t
\newcommand{\tyexist}[4]{\EM{\exists\varbound{#1}{#2}{#3}.#4}}

%% lists of types
%\newcommand{\tys}{\EM{\ol{\ty}}}
\newcommand{\tys}{\EM{\ty,\ldots}}
%% list of restricted existential vars
\newcommand{\rexvars}{\EM{\rexvar,\ldots}}

%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Type Examples

\newcommand{\tyint}{\tyname{Int}}
\newcommand{\tyflt}{\tyname{Flt}}
\newcommand{\tystr}{\tyname{Str}}

\newcommand{\nref}{\tyname{Ref}}
\newcommand{\ninvpair}{\tyname{Tuple}}

\newcommand{\vx}{\var{X}}
\newcommand{\vy}{\var{Y}}
\newcommand{\vany}{\var{V}}
\newcommand{\va}{\EM{\alpha}}
\newcommand{\vb}{\EM{\beta}}

%% Meta functions
%% *********************************************************

%\DeclareMathOperator{\ubop}{\mathit{ub}}    %% upper bound
%\DeclareMathOperator{\lbop}{\mathit{lb}}    %% lower bound

\DeclareMathOperator{\fvop}{\mathit{FV}}
\DeclareMathOperator{\domop}{\mathit{dom}}
\newcommand{\fv}[1]{\EM{\fvop(#1)}}
\newcommand{\dom}[1]{\EM{\domop(#1)}}

\DeclareMathOperator{\occop}{\mathit{occ}}
\newcommand{\occ}[2]{\EM{\occop(#1;#2)}}
\newcommand{\occdflt}[1]{\occ{\vany}{#1}}

%\newcommand{\ub}[2]{\EM{\ubop(#1,#2)}}
%\newcommand{\ubdflt}[1]{\ub{\AEnv}{#1}}
%\newcommand{\lb}[2]{\EM{\lbop(#1, #2)}}
%\newcommand{\lbdflt}[1]{\lb{\AEnv}{#1}}

\DeclareMathOperator{\solvectrop}{\mathbf{Solve}}
\newcommand{\solvectr}[3]{\EM{\solvectrop(#1;#2;#3)}}
\newcommand{\solvectrdflt}{\solvectr{\AEnv}{\UEnv}{\CSet}}

\newcommand{\size}[1]{\EM{|#1|}}

\DeclareMathOperator{\msrop}{\mathcal{M}}
\newcommand{\tymsr}[2]{\EM{\msrop(#1;#2)}}
\newcommand{\tymsrdflt}[1]{\tymsr{\AEnv}{#1}}

\newcommand{\tyjoin}[3]{\EM{#2 \sqcup_{#1} #3}}
\newcommand{\tyjoindflt}[2]{\tyjoin{\AEnv}{#1}{#2}}
\newcommand{\tymeet}[3]{\EM{#2 \sqcap_{#1} #3}}
\newcommand{\tymeetdflt}[2]{\tymeet{\AEnv}{#1}{#2}}

%% Relations
%% *********************************************************

%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Validity

\newcommand{\tyvld}[2]{\EM{#1\,\vdash\,#2}}
\newcommand{\tyvlddflt}[1]{\tyvld{\AEnv}{#1}}

\newcommand{\tyunfvld}[3]{\EM{#1\Alt#2\,\vdash\,#3}}
\newcommand{\tyunfvlddflt}[1]{\tyunfvld{\AEnv}{\UEnvD}{#1}}

\newcommand{\vldinenv}[3]{\EM{#2\,\vDash_{#1}\,#3}}
\newcommand{\vldinenvdflt}[1]{\vldinenv{\AEnv'}{\AEnv}{#1}}

%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Inheritance

\newcommand{\inherits}[2]{\EM{#1 \text{ inherits } #2}}

%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Subtyping

\DeclareMathOperator{\symsub}{<:}               %% subtyping

\DeclareMathOperator{\symsubctr}{\lessdot}   %% constrained subtyping
\DeclareMathOperator{\symsubctrL}{\bullet\!\!\lessdot} %% constrained left subtyping
\DeclareMathOperator{\symsubctrR}{\lessdot\!\!\bullet} %% constrained right subtyping

\DeclareMathOperator{\symrexvarsub}{\ll}        %% restricted existential bounds

%% Subtyping signatures Γ|Δ |- s1 <: s2
\newcommand{\subtysig}[4]{\EM{#1\Alt#2\ \vdash\ #3 \symsub #4}}
\newcommand{\subtysigdflt}[2]{\subtysig{\AEnv}{\UEnv}{#1}{#2}}

%% Subtyping Γ |- t1 <: t2
\newcommand{\subty}[3]{\EM{#1\ \vdash\ #2 \symsub #3}}
\newcommand{\subtydflt}[2]{\subty{\AEnv}{#1}{#2}}

%% Constrained subtyping Γ|H |- t1 ⊲ t2 -> Κ
\newcommand{\subtyctrtmplt}[6]{\EM{#2\Alt#3\ \vdash\ #4 #1 #5\ \rightsquigarrow\ #6}}
\newcommand{\subtyctr}[5]{\subtyctrtmplt{\symsubctr}{#1}{#2}{#3}{#4}{#5}}
\newcommand{\subtyctrdflt}[2]{\subtyctr{\AEnv}{\UEnvD}{#1}{#2}{\CSet}}
\newcommand{\subtyctrdfltenv}[3]{\subtyctr{\AEnv}{\UEnvD}{#1}{#2}{#3}}
\newcommand{\subtyctrL}[5]{\subtyctrtmplt{\symsubctrL}{#1}{#2}{#3}{#4}{#5}}
\newcommand{\subtyctrLdflt}[2]{\subtyctrL{\AEnv}{\UEnvD}{#1}{#2}{\CSet}}
\newcommand{\subtyctrLdfltenv}[3]{\subtyctrL{\AEnv}{\UEnvD}{#1}{#2}{#3}}
\newcommand{\subtyctrR}[5]{\subtyctrtmplt{\symsubctrR}{#1}{#2}{#3}{#4}{#5}}
\newcommand{\subtyctrRdflt}[2]{\subtyctrR{\AEnv}{\UEnvD}{#1}{#2}{\CSet}}
\newcommand{\subtyctrRdfltenv}[3]{\subtyctrR{\AEnv}{\UEnvD}{#1}{#2}{#3}}


%% Lambda-Julia
%% *********************************************************

\newcommand{\ljsub}[4]{\EM{#1 \vdash #2 <: #3 \vdash #4}}

\renewcommand{\t}{\ensuremath{t}\xspace}
\newcommand{\T}{\ensuremath{\mathrm{T}}\xspace}
\renewcommand{\S}{\ensuremath{\mathrm{S}}\xspace}
\newcommand{\Q}{\ensuremath{\mathrm{Q}}\xspace}
\newcommand{\tytext}[1]{\ensuremath{\text{\texttt{#1}}}\xspace}
\newcommand{\Barrier}{\tytext{Barrier}}
\newcommand{\jlname}[1]{\tytext{\textcolor{jlbuiltin}{#1}}}
\newcommand{\anytyp}{\jlname{Any}}
\newcommand{\inttyp}{\jlname{Int}}
\newcommand{\reftyp}[1]{\cstrt{\jlname{Ref}}{#1}}
\newcommand{\vectyp}[1]{\cstrt{\jlname{Vector}}{#1}}
\newcommand{\dicttyp}[1]{\cstrt{\jlname{Dict}}{#1}}
\newcommand{\tupletyp}[1]{\jlname{Tuple}\{#1\}}
\newcommand{\uniontyp}[1]{\jlname{Union}\{#1\}}
\newcommand{\cstrt}[2]{\tytext{#1}\{#2\}}
\newcommand{\wheret}[2]{\ensuremath{#1\;\textbf{\texttt{where}}\;#2}}